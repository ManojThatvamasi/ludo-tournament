<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Boys LUDO Tournament</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd8;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #e53e3e;
            --warning: #ed8936;
            --dark: #2d3748;
            --light: #f7fafc;
            --gray: #718096;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
        }

        .role-selector {
            display: flex;
            margin-bottom: 30px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .role-btn.active {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #dd771c;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .points-table th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .points-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .points-table tr:nth-child(even) {
            background: #f7fafc;
        }

        .points-table tr:hover {
            background: #edf2f7;
        }

        .team-points {
            font-weight: bold;
            color: var(--dark);
        }

        .admin-controls {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .match-card {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-teams {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .team-name {
            font-weight: 600;
            color: var(--dark);
        }

        .vs {
            color: var(--gray);
            font-weight: bold;
        }

        .match-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fed7d7;
            color: var(--danger);
        }

        .status-completed {
            background: #c6f6d5;
            color: var(--success);
        }

        .status-abandoned {
            background: #e2e8f0;
            color: var(--gray);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .team-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-players {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .drag-handle {
            cursor: move;
            color: var(--gray);
            padding: 5px;
        }

        .match-actions {
            display: flex;
            gap: 5px;
            flex-direction: column;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .points-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .points-table {
                min-width: 700px;
                font-size: 0.85rem;
            }

            .points-table th,
            .points-table td {
                padding: 12px 8px;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .match-card {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }

            .match-teams {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .team-players {
                font-size: 0.8rem;
            }

            .team-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .form-control {
                font-size: 16px;
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            .action-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .points-table {
                min-width: 600px;
                font-size: 0.8rem;
            }

            .points-table th,
            .points-table td {
                padding: 10px 6px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .login-box {
                padding: 25px 20px;
                margin: 10px;
            }

            .tab-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
            }
        }

        /* Position colors */
        .position-1 {
            background: linear-gradient(90deg, #fff9db 0%, #fff3cd 100%) !important;
            border-left: 4px solid gold !important;
        }
        
        .position-2 {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%) !important;
            border-left: 4px solid silver !important;
        }
        
        .position-3 {
            background: linear-gradient(90deg, #fff3e6 0%, #ffe8cc 100%) !important;
            border-left: 4px solid #cd7f32 !important;
        }
        
        /* Points table row styling */
        .points-table tr.position-1 td:first-child {
            font-weight: bold;
            color: #856404;
        }
        
        .points-table tr.position-2 td:first-child {
            font-weight: bold;
            color: #6c757d;
        }
        
        .points-table tr.position-3 td:first-child {
            font-weight: bold;
            color: #cd7f32;
        }

        /* Add to CSS section */
        .playoff-match-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .playoff-match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .playoff-match-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .playoff-teams {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
        }
        
        .playoff-team {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f7fafc;
            min-width: 150px;
        }
        
        .playoff-vs {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gray);
            margin: 0 20px;
        }
        
        .qualified-team-badge {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .playoff-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        
        .playoff-status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .playoff-pending {
            background: #fed7d7;
            color: var(--danger);
        }
        
        .playoff-completed {
            background: #c6f6d5;
            color: var(--success);
        }
        
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="container login-container" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">üé≤ MC Boys LUDO</h1>
            <p class="login-subtitle">Tournament Management System</p>

            <div class="role-selector">
                <button class="role-btn active" id="viewerRole">Viewer</button>
                <button class="role-btn" id="adminRole">Admin</button>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
            </div>

            <button class="btn" id="loginBtn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>

            <div id="loginHelp" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading passwords from database...</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container app-container" id="appContainer">
        <div class="header">
            <div>
                <h1>üèÜ MC Boys LUDO Tournament</h1>
                <p>Season -1 2025 - Competitive LUDO Championship</p>
            </div>
            <div class="user-info">
                <span id="connectionStatus" style="background: var(--success); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: none;">
                    <i class="fas fa-cloud"></i> Real-Time
                </span>
                <span id="userRoleDisplay"></span>
                <button class="btn btn-warning" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn" id="welcomeTab" onclick="showTab('welcome')">
                <i class="fas fa-home"></i> Welcome
            </button>
            <button class="tab-btn active" id="pointsTab" onclick="showTab('points')">
                <i class="fas fa-table"></i> Points Table
            </button>
            <button class="tab-btn" id="scheduleTab" onclick="showTab('schedule')">
                <i class="fas fa-calendar-alt"></i> Matches
            </button>
            <button class="tab-btn admin-only" id="adminTab" onclick="showTab('admin')">
                <i class="fas fa-cogs"></i> Admin Panel
            </button>
        </div>

        <!-- Welcome Tab -->
        <div id="welcome" class="tab-content">
            <h2>üé≤ Welcome to MC Boys LUDO Tournament!</h2>
            <p style="margin: 20px 0; font-size: 1.1rem; line-height: 1.6;">
                Get ready for an exciting LUDO tournament featuring competitive teams.
                Follow the matches, track points, and see who emerges as the ultimate champion!
            </p>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-info-circle"></i> Tournament Rules</h3>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>Win: 2 points</li>
                    <li>Lose: 0 points</li>
                    <li>No draws - every match has a winner</li>
                    <li>Multiple teams competing for the championship</li>
                </ul>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-trophy"></i> Current Leader</h3>
                <div id="currentLeader" style="font-size: 1.2rem; font-weight: bold; color: var(--primary); margin: 10px 0;">... No teams yet
                </div>
            </div>
        </div>

        <!-- Points Table Tab -->
        <div id="points" class="tab-content active">
            <h2>üìä Tournament Points Table</h2>

            <div id="points-empty" class="empty-state" style="display: none;">
                <i class="fas fa-users"></i>
                <h3>No Teams Yet</h3>
                <p>Add teams in the Admin Panel to get started</p>
            </div>

            <div class="points-table-container">
                <table class="points-table" id="points-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>Players</th>
                            <th>Matches</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="points-table-body">
                        <!-- Points table will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success admin-only" onclick="downloadPointsTable()">
                    <i class="fas fa-download"></i> Download Excel
                </button>
            </div>

            <div class="card admin-only" style="margin-top: 20px;">
                <h3 class="card-title"><i class="fas fa-filter"></i> Team Consideration</h3>
                <p style="margin-bottom: 10px; color: var(--gray);">
                    Consider only top N teams in points table display
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>Number of Teams to Consider</label>
                        <input type="number" id="considerTeamsCount" class="form-control" 
                               min="1" placeholder="Show all teams">
                    </div>
                </div>
                <button class="btn" onclick="applyTeamConsideration()">
                    <i class="fas fa-filter"></i> Apply Filter
                </button>
                <button class="btn btn-warning" onclick="resetTeamConsideration()" style="margin-left: 10px;">
                    <i class="fas fa-redo"></i> Show All Teams
                </button>
            </div>
            
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <h2>üìÖ Tournament Matches</h2>

            <div id="matches-empty" class="empty-state" style="display: none;">
                <i class="fas fa-calendar-times"></i>
                <h3>No Matches Scheduled</h3>
                <p>Add matches between teams to create the tournament schedule</p>
            </div>

            <div class="admin-controls admin-only">
                <h3><i class="fas fa-plus-circle"></i> Add New Match</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Team 1</label>
                        <select id="newTeam1" class="form-control">
                            <option value="">Select Team 1</option>
                            <!-- Teams will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Team 2</label>
                        <select id="newTeam2" class="form-control">
                            <option value="">Select Team 2</option>
                            <!-- Teams will be populated by JavaScript -->
                        </select>
                    </div>

                   

                </div>
                <button class="btn" onclick="addNewMatch()">
                    <i class="fas fa-plus"></i> Add Match
                </button>
            </div>

            <div class="admin-controls admin-only" id="reorder-controls" style="display: none;">
                <h3><i class="fas fa-sort"></i> Reorder Matches</h3>
                <p>Drag and drop matches to rearrange the schedule</p>
                <button class="btn btn-warning" onclick="saveMatchOrder()">
                    <i class="fas fa-save"></i> Save New Order
                </button>
            </div>

            <div id="matches-container">
                <!-- Matches will be populated by JavaScript -->
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin" class="tab-content">
            <h2>‚öôÔ∏è Admin Panel</h2>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-users"></i> Manage Teams</h3>
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="newTeamName" class="form-control" placeholder="Enter team name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="player1Name" class="form-control" placeholder="Player 1 name">
                    </div>
                    <div class="form-group">
                        <input type="text" id="player2Name" class="form-control" placeholder="Player 2 name">
                    </div>
                </div>
                <button class="btn" onclick="addNewTeam()">
                    <i class="fas fa-plus"></i> Add Team
                </button>

                <div id="teams-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-user-plus"></i>
                    <h3>No Teams Added Yet</h3>
                    <p>Start by adding your first team above</p>
                </div>

                <div id="teams-list" style="margin-top: 15px;">
                    <!-- Teams list will be populated by JavaScript -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-key"></i> Password Management</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Admin Password</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="New admin password">
                    </div>
                    <div class="form-group">
                        <label>Viewer Password</label>
                        <input type="password" id="viewerPassword" class="form-control" placeholder="New viewer password">
                    </div>
                </div>
                <button class="btn btn-warning" onclick="updatePasswords()">
                    <i class="fas fa-save"></i> Update Passwords
                </button>
                <p style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> Passwords are securely stored in the database
                </p>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-database"></i> Tournament Data</h3>
                <button class="btn btn-danger" onclick="resetTournament()">
                    <i class="fas fa-trash"></i> Reset Tournament
                </button>
                <button class="btn" onclick="exportTournamentData()" style="margin-left: 10px;">
                    <i class="fas fa-file-export"></i> Export Data
                </button>
                <button class="btn" onclick="importTournamentData()" style="margin-left: 10px;">
                    <i class="fas fa-file-import"></i> Import Data
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-trophy"></i> Playoff / Qualifier Management</h3>
                
                <!-- League Completion Section -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: var(--dark);">
                        <i class="fas fa-flag-checkered"></i> League Stage Completion
                    </h4>
                    <p style="margin-bottom: 15px; color: var(--gray);">
                        Complete the league stage to start playoffs/qualifiers
                    </p>
                    <button class="btn ${tournamentData.seasonCompleted ? 'btn-warning' : 'btn-success'}" 
                            onclick="completeLeagueStage()" id="completeLeagueBtn">
                        <i class="fas ${tournamentData.seasonCompleted ? 'fa-redo' : 'fa-check'}"></i> 
                        ${tournamentData.seasonCompleted ? 'Re-open League Stage' : 'Complete League Stage'}
                    </button>
                    <div style="margin-top: 10px; font-size: 0.9rem;">
                        Status: <span id="leagueStatus" style="font-weight: bold;">
                            ${tournamentData.seasonCompleted ? 'Completed ‚úÖ' : 'Ongoing ‚è≥'}
                        </span>
                    </div>
                </div>
            
                <!-- Playoff Setup Section -->
                <div id="playoffSetupSection" style="${tournamentData.seasonCompleted ? '' : 'display: none;'} 
                        margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: var(--dark);">
                        <i class="fas fa-play"></i> Setup Playoffs
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Number of Teams for Playoffs</label>
                            <input type="number" id="playoffTeamsCount" class="form-control" 
                                   min="2" max="8" value="${tournamentData.playoffTeamsCount || 4}">
                        </div>
                    </div>
                    <button class="btn" onclick="setupPlayoffs()">
                        <i class="fas fa-cogs"></i> Setup Playoff Bracket
                    </button>
                    
                    <!-- Current Qualified Teams Display -->
                    <div id="qualifiedTeamsDisplay" style="margin-top: 15px; display: none;">
                        <h5 style="color: var(--dark); margin-bottom: 10px;">Qualified Teams:</h5>
                        <div id="qualifiedTeamsList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Qualified teams will appear here -->
                        </div>
                    </div>
                </div>
            
                <!-- Playoff Matches Management -->
                <div id="playoffMatchesSection" style="${tournamentData.playoffStage === 'ongoing' ? '' : 'display: none;'} 
                        padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: var(--dark);">
                        <i class="fas fa-gamepad"></i> Playoff Matches
                    </h4>
                    
                    <!-- Add Playoff Match Form -->
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <h5 style="margin-bottom: 10px;">Add Playoff Match</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Match Name</label>
                                <input type="text" id="playoffMatchName" class="form-control" 
                                       placeholder="e.g., Eliminator, Semi-Final 1, Final">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Team 1</label>
                                <select id="playoffTeam1" class="form-control">
                                    <option value="">Select Team 1</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Team 2</label>
                                <select id="playoffTeam2" class="form-control">
                                    <option value="">Select Team 2</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn" onclick="addPlayoffMatch()">
                            <i class="fas fa-plus"></i> Add Playoff Match
                        </button>
                    </div>
            
                    <!-- Playoff Matches List -->
                    <div id="playoffMatchesList">
                        <!-- Playoff matches will appear here -->
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyAQDJbWsCDbgKMdmMZ8Rz_QmTo-kW6ZdHM",
      authDomain: "ludo-tournament-d6e32.firebaseapp.com",
      projectId: "ludo-tournament-d6e32",
      storageBucket: "ludo-tournament-d6e32.firebasestorage.app",
      messagingSenderId: "245161933582",
      appId: "1:245161933582:web:9d18c5bfc74a41f705b55f",
      measurementId: "G-3R2EZR2HK9"
    };  

    let db = null;
    let isFirebaseConnected = false;

    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isFirebaseConnected = true;
        console.log('Firebase connected');
        document.getElementById('connectionStatus').style.display = 'inline-block';
    } catch (e) {
        console.log('Firebase init failed, using local storage instead');
    }  

    // ==================== TOURNAMENT DATA STRUCTURE ====================
    let tournamentData = {
        teams: [],
        matches: [],
        playoffMatches: [], 
        passwords: { admin: "", viewer: "" },
        nextTeamId: 1,
        nextMatchId: 1,
        nextPlayoffMatchId: 1,
        seasonCompleted: false, 
        playoffTeamsCount: 0, 
        playoffStage: 'not_started'
    };

    let currentUser = null;
    let isDragging = false;
    let draggedElement = null;
    let passwordsLoaded = false;  

    // ==================== FIREBASE DATA MANAGEMENT ====================
    async function saveData() {
         tournamentData = {
                ...tournamentData,
                playoffMatches: tournamentData.playoffMatches || [],
                nextPlayoffMatchId: tournamentData.nextPlayoffMatchId || 1,
                seasonCompleted: tournamentData.seasonCompleted || false,
                playoffTeamsCount: tournamentData.playoffTeamsCount || 0,
                playoffStage: tournamentData.playoffStage || 'not_started'
            };
        if (db && isFirebaseConnected) {
            try {
                await db.collection('tournament').doc('data').set(tournamentData);
                console.log('‚úÖ Data saved to Firebase');
            } catch (error) {
                console.error('‚ùå Firebase error:', error);
                localStorage.setItem('ludoTournamentData', JSON.stringify(tournamentData));
            }
        } else {
            localStorage.setItem('ludoTournamentData', JSON.stringify(tournamentData));
        }
        updateAllDisplays();
    }  

        function updateAdminUIState() {
    // Update league completion button
    const completeBtn = document.getElementById('completeLeagueBtn');
    if (completeBtn) {
        completeBtn.className = `btn ${tournamentData.seasonCompleted ? 'btn-warning' : 'btn-success'}`;
        completeBtn.innerHTML = `
            <i class="fas ${tournamentData.seasonCompleted ? 'fa-redo' : 'fa-check'}"></i> 
            ${tournamentData.seasonCompleted ? 'Re-open League Stage' : 'Complete League Stage'}
        `;
    }
    
    // Update league status
    const leagueStatus = document.getElementById('leagueStatus');
    if (leagueStatus) {
        leagueStatus.innerHTML = tournamentData.seasonCompleted ? 'Completed ‚úÖ' : 'Ongoing ‚è≥';
    }
    
    // Show/hide playoff sections
    const playoffSetup = document.getElementById('playoffSetupSection');
    if (playoffSetup) {
        playoffSetup.style.display = tournamentData.seasonCompleted ? 'block' : 'none';
    }
    
    const playoffMatches = document.getElementById('playoffMatchesSection');
    if (playoffMatches) {
        playoffMatches.style.display = tournamentData.playoffStage === 'ongoing' ? 'block' : 'none';
    }
    
    // Update playoff teams count input
    const playoffCountInput = document.getElementById('playoffTeamsCount');
    if (playoffCountInput) {
        playoffCountInput.value = tournamentData.playoffTeamsCount || 4;
    }
    
    // Update displays
    updateQualifiedTeamsDisplay();
    updatePlayoffTeamSelects();
    updatePlayoffMatchesDisplay();
}
        
    function loadData() {
        if (db && isFirebaseConnected) {
            showLoadingMessage('Loading from database...');

            db.collection('tournament').doc('data').get().then((doc) => {
                if (doc.exists) {
                    tournamentData = doc.data();
                    passwordsLoaded = true;
                    hideLoadingMessage();
                    console.log('‚úÖ Passwords loaded from Firebase');
                    updateAllDisplays();
                } else {
                    initializeFirstTimeData();
                }
            }).catch((error) => {
                console.error('Error loading data:', error);
                loadFromLocalStorage();
            });
        } else {
            loadFromLocalStorage();
        }
    }  

    function initializeFirstTimeData() {
        tournamentData.passwords = {
            admin: "admin123",
            viewer: "view123"
        };
        passwordsLoaded = true;
        saveData();
        hideLoadingMessage();
        console.log('üéØ First-time data initialized with default passwords');
    }  

    function loadFromLocalStorage() {
        const saved = localStorage.getItem('ludoTournamentData');
        if (saved) {
            tournamentData = JSON.parse(saved);
            passwordsLoaded = true;
        } else {
            tournamentData.passwords = { admin: "admin123", viewer: "view123" };
            passwordsLoaded = true;
            saveData();
        }
        hideLoadingMessage();
        updateAllDisplays();
    }  

    function showLoadingMessage(message) {
        document.getElementById('loginHelp').style.display = 'block';
        document.getElementById('loginHelp').innerHTML =
            `<i class="fas fa-spinner fa-spin"></i><p>${message}</p>`;
    }

    function hideLoadingMessage() {
        document.getElementById('loginHelp').style.display = 'none';
    }

    // ==================== AUTHENTICATION SYSTEM ====================
    function checkAuthentication() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            if (passwordsLoaded) {
                showApp();
            } else {
                setTimeout(checkAuthentication, 100);
            }
        }
    }  

    function login() {
        if (!passwordsLoaded) {
            alert('System still loading. Please wait...');
            return;
        }

        const role = document.getElementById('viewerRole').classList.contains('active')
            ? 'viewer' : 'admin';
        const password = document.getElementById('password').value.trim();
        const storedPassword = tournamentData.passwords[role];

        if (!storedPassword) {
            alert('Password not set in database. Please contact administrator.');
            return;
        }

        if (password === storedPassword) {
            currentUser = { role, loginTime: new Date().toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
        } else {
            alert('Invalid password! Please try again.');
        }
    }  

    function logout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showLogin();
    }

    function showLogin() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('password').value = '';
        selectRole('viewer'); // reset role on logout
    }  

    function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userRoleDisplay').textContent =
        `Logged in as ${currentUser.role}`;

    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
    });
    document.getElementById('adminTab').style.display =
        currentUser.role === 'admin' ? 'flex' : 'none';

    // force default tab per role
    if (currentUser.role === 'admin') {
        showTab('admin');
    } else {
        showTab('welcome');
    }

    updateAllDisplays();
}

        function completeLeagueStage() {
    tournamentData.seasonCompleted = !tournamentData.seasonCompleted;
    
    if (tournamentData.seasonCompleted) {
        // Show playoff setup section
        document.getElementById('playoffSetupSection').style.display = 'block';
        updateQualifiedTeamsDisplay();
        alert('League stage completed! You can now setup playoffs.');
    } else {
        // Hide playoff sections
        document.getElementById('playoffSetupSection').style.display = 'none';
        document.getElementById('playoffMatchesSection').style.display = 'none';
        tournamentData.playoffStage = 'not_started';
        alert('League stage re-opened for modifications.');
    }
    
    saveData();
}

// ==================== PLAYOFF SETUP ====================
function setupPlayoffs() {
    const countInput = document.getElementById('playoffTeamsCount');
    const count = parseInt(countInput.value);
    
    if (isNaN(count) || count < 2 || count > tournamentData.teams.length) {
        alert(`Please enter a valid number between 2 and ${tournamentData.teams.length}`);
        return;
    }
    
    tournamentData.playoffTeamsCount = count;
    tournamentData.playoffStage = 'ongoing';
    
    // Clear existing playoff matches
    tournamentData.playoffMatches = [];
    tournamentData.nextPlayoffMatchId = 1;
    
    // Show playoff matches section
    document.getElementById('playoffMatchesSection').style.display = 'block';
    
    // Update qualified teams display
    updateQualifiedTeamsDisplay();
    
    // Update team selects for playoff matches
    updatePlayoffTeamSelects();
    
    // Update playoff matches list
    updatePlayoffMatchesDisplay();
    
    saveData();
    
    alert(`Playoffs setup complete! Top ${count} teams will compete in playoffs.`);
}

// ==================== QUALIFIED TEAMS DISPLAY ====================
function updateQualifiedTeamsDisplay() {
    if (!tournamentData.seasonCompleted) return;
    
    const qualifiedTeamsDiv = document.getElementById('qualifiedTeamsDisplay');
    const teamsListDiv = document.getElementById('qualifiedTeamsList');
    
    // Sort teams by points (with tiebreaker: fewer matches first)
    const sortedTeams = [...tournamentData.teams].sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        return a.matches - b.matches;
    });
    
    // Get qualified teams
    const qualifiedTeams = sortedTeams.slice(0, tournamentData.playoffTeamsCount || 4);
    
    if (qualifiedTeams.length === 0) {
        qualifiedTeamsDiv.style.display = 'none';
        return;
    }
    
    qualifiedTeamsDiv.style.display = 'block';
    teamsListDiv.innerHTML = '';
    
    qualifiedTeams.forEach((team, index) => {
        const teamBadge = document.createElement('div');
        teamBadge.className = 'qualified-team-badge';
        teamBadge.innerHTML = `
            <span>${index + 1}. ${team.name}</span>
            <small>(${team.points} pts)</small>
        `;
        teamsListDiv.appendChild(teamBadge);
    });
}

// ==================== PLAYOFF MATCH MANAGEMENT ====================
function updatePlayoffTeamSelects() {
    const sortedTeams = [...tournamentData.teams].sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        return a.matches - b.matches;
    });
    
    const qualifiedTeams = sortedTeams.slice(0, tournamentData.playoffTeamsCount || 4);
    
    const team1Select = document.getElementById('playoffTeam1');
    const team2Select = document.getElementById('playoffTeam2');
    
    team1Select.innerHTML = '<option value="">Select Team 1</option>';
    team2Select.innerHTML = '<option value="">Select Team 2</option>';
    
    qualifiedTeams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name} (${team.points} pts)`;
        
        const option2 = option1.cloneNode(true);
        
        team1Select.appendChild(option1);
        team2Select.appendChild(option2);
    });
}

function addPlayoffMatch() {
    const matchName = document.getElementById('playoffMatchName').value.trim();
    const team1Id = parseInt(document.getElementById('playoffTeam1').value);
    const team2Id = parseInt(document.getElementById('playoffTeam2').value);
    
    if (!matchName) {
        alert('Please enter a match name (e.g., Eliminator, Semi-Final, Final)');
        return;
    }
    
    if (!team1Id || !team2Id) {
        alert('Please select both teams');
        return;
    }
    
    if (team1Id === team2Id) {
        alert('Please select two different teams');
        return;
    }
    
    // Check if this playoff match already exists
    const duplicateMatch = tournamentData.playoffMatches.find(match => 
        match.name === matchName || 
        (match.team1 === team1Id && match.team2 === team2Id) ||
        (match.team1 === team2Id && match.team2 === team1Id)
    );
    
    if (duplicateMatch) {
        alert('This playoff match already exists!');
        return;
    }
    
    // Add playoff match
    tournamentData.playoffMatches.push({
        id: tournamentData.nextPlayoffMatchId++,
        name: matchName,
        team1: team1Id,
        team2: team2Id,
        winner: null,
        completed: false,
        resultTimestamp: null
    });
    
    // Clear inputs
    document.getElementById('playoffMatchName').value = '';
    document.getElementById('playoffTeam1').value = '';
    document.getElementById('playoffTeam2').value = '';
    
    updatePlayoffMatchesDisplay();
    saveData();
}

function updatePlayoffMatchesDisplay() {
    const container = document.getElementById('playoffMatchesList');
    container.innerHTML = '';
    
    if (tournamentData.playoffMatches.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 30px; color: var(--gray);">
                <i class="fas fa-trophy" style="font-size: 3rem; opacity: 0.5;"></i>
                <h3>No Playoff Matches Yet</h3>
                <p>Add playoff matches using the form above</p>
            </div>
        `;
        return;
    }
    
    tournamentData.playoffMatches.forEach(match => {
        const team1 = tournamentData.teams.find(t => t.id === match.team1);
        const team2 = tournamentData.teams.find(t => t.id === match.team2);
        
        if (!team1 || !team2) return;
        
        const matchCard = document.createElement('div');
        matchCard.className = 'playoff-match-card';
        
        let statusHtml = '<span class="playoff-status-badge playoff-pending">‚è≥ Pending</span>';
        let winnerSelect = '';
        let resultActions = '';
        
        if (match.completed) {
            const winnerTeam = tournamentData.teams.find(t => t.id === match.winner);
            statusHtml = `
                <span class="playoff-status-badge playoff-completed">‚úÖ Completed</span>
                <div style="margin-top: 5px; color: var(--success); font-weight: bold;">
                    Winner: ${winnerTeam ? winnerTeam.name : 'Unknown'}
                </div>
            `;
        } else {
            winnerSelect = `
                <select id="playoffWinner-${match.id}" class="form-control" style="margin-bottom: 10px;">
                    <option value="">Select Winner</option>
                    <option value="${team1.id}">${team1.name}</option>
                    <option value="${team2.id}">${team2.name}</option>
                </select>
                <button class="btn btn-sm btn-success" onclick="updatePlayoffMatchResult(${match.id})">
                    <i class="fas fa-check"></i> Set Result
                </button>
            `;
        }
        
        matchCard.innerHTML = `
            <div class="playoff-match-header">
                <div>
                    <div class="playoff-match-name">${match.name}</div>
                    <div style="font-size: 0.9rem; color: var(--gray);">
                        Playoff Match #${match.id}
                    </div>
                </div>
                <div>${statusHtml}</div>
            </div>
            
            <div class="playoff-teams">
                <div class="playoff-team">
                    <div style="font-weight: bold; font-size: 1.1rem;">${team1.name}</div>
                    <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                        ${team1.player1}, ${team1.player2}
                    </div>
                    <div style="margin-top: 10px; color: var(--primary);">
                        ${team1.points} pts ‚Ä¢ ${team1.wins}W ${team1.losses}L
                    </div>
                </div>
                
                <div class="playoff-vs">VS</div>
                
                <div class="playoff-team">
                    <div style="font-weight: bold; font-size: 1.1rem;">${team2.name}</div>
                    <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                        ${team2.player1}, ${team2.player2}
                    </div>
                    <div style="margin-top: 10px; color: var(--primary);">
                        ${team2.points} pts ‚Ä¢ ${team2.wins}W ${team2.losses}L
                    </div>
                </div>
            </div>
            
            <div class="playoff-actions">
                ${winnerSelect}
                <button class="btn btn-sm btn-danger" onclick="deletePlayoffMatch(${match.id})" 
                        style="margin-left: 10px;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(matchCard);
    });
}

function updatePlayoffMatchResult(matchId) {
    const winnerSelect = document.getElementById(`playoffWinner-${matchId}`);
    const winnerId = parseInt(winnerSelect.value);
    
    if (!winnerId) {
        alert('Please select a winner');
        return;
    }
    
    const match = tournamentData.playoffMatches.find(m => m.id === matchId);
    if (!match || match.completed) return;
    
    match.winner = winnerId;
    match.completed = true;
    match.resultTimestamp = new Date().toISOString();
    
    // Update team stats (optional - playoff wins don't affect league points)
    const winner = tournamentData.teams.find(t => t.id === winnerId);
    const loser = tournamentData.teams.find(t => 
        t.id === (match.team1 === winnerId ? match.team2 : match.team1));
    
    // You can track playoff stats separately if needed
    // For now, just mark the playoff match as completed
    
    updatePlayoffMatchesDisplay();
    saveData();
    
    alert(`${winner.name} wins the ${match.name}!`);
}

function deletePlayoffMatch(matchId) {
    if (!confirm('Are you sure you want to delete this playoff match?')) return;
    
    tournamentData.playoffMatches = tournamentData.playoffMatches.filter(
        match => match.id !== matchId
    );
    
    updatePlayoffMatchesDisplay();
    saveData();
}

        let considerTeamsCount = 0; // 0 means show all teams

function applyTeamConsideration() {
    const countInput = document.getElementById('considerTeamsCount');
    const count = parseInt(countInput.value);
    
    if (isNaN(count) || count < 1) {
        considerTeamsCount = 0; // Show all
        alert('Showing all teams');
    } else {
        considerTeamsCount = count;
        alert(`Now showing top ${count} teams only`);
    }
    
    updatePointsTable();
    updateLeaderDisplay();
}

function resetTeamConsideration() {
    considerTeamsCount = 0;
    document.getElementById('considerTeamsCount').value = '';
    updatePointsTable();
    updateLeaderDisplay();
}


    // ==================== PASSWORD MANAGEMENT ====================
    function updatePasswords() {
        const adminPass = document.getElementById('adminPassword').value.trim();
        const viewerPass = document.getElementById('viewerPassword').value.trim();

        if (!adminPass && !viewerPass) {
            alert('Please enter at least one new password');
            return;
        }

        if (adminPass && adminPass.length < 4) {
            alert('Admin password must be at least 4 characters long');
            return;
        }
        if (viewerPass && viewerPass.length < 4) {
            alert('Viewer password must be at least 4 characters long');
            return;
        }

        if (adminPass) tournamentData.passwords.admin = adminPass;
        if (viewerPass) tournamentData.passwords.viewer = viewerPass;

        document.getElementById('adminPassword').value = '';
        document.getElementById('viewerPassword').value = '';

        saveData();
        alert('Passwords updated successfully in database!');
    }  

    // ==================== TEAM MANAGEMENT ====================
    function addNewTeam() {
        const nameInput = document.getElementById('newTeamName');
        const player1Input = document.getElementById('player1Name');
        const player2Input = document.getElementById('player2Name');

        const name = nameInput.value.trim();
        const player1 = player1Input.value.trim();
        const player2 = player2Input.value.trim();

        if (!name || !player1 || !player2) {
            alert('Please enter team name and both player names');
            return;
        }

        if (tournamentData.teams.some(team =>
            team.name.toLowerCase() === name.toLowerCase())) {
            alert('Team name already exists! Please choose a different name.');
            return;
        }

        tournamentData.teams.push({
            id: tournamentData.nextTeamId++,
            name,
            player1,
            player2,
            matches: 0,
            wins: 0,
            losses: 0,
            points: 0
        });

        nameInput.value = '';
        player1Input.value = '';
        player2Input.value = '';
        saveData();
    }  

    function editTeam(teamId) {
        const team = tournamentData.teams.find(t => t.id === teamId);
        if (!team) return;

        const newName = prompt('Enter new team name:', team.name);
        if (newName === null) return;

        const newPlayer1 = prompt('Enter Player 1 name:', team.player1);
        if (newPlayer1 === null) return;

        const newPlayer2 = prompt('Enter Player 2 name:', team.player2);
        if (newPlayer2 === null) return;

        if (tournamentData.teams.some(t =>
            t.id !== teamId && t.name.toLowerCase() === newName.toLowerCase())) {
            alert('Team name already exists! Please choose a different name.');
            return;
        }

        team.name = newName.trim();
        team.player1 = newPlayer1.trim();
        team.player2 = newPlayer2.trim();

        saveData();
    }  

    function deleteTeam(teamId) {
        if (!confirm('Are you sure you want to delete this team? This will also delete all matches involving this team.')) {
            return;
        }

        tournamentData.teams = tournamentData.teams.filter(team => team.id !== teamId);
        tournamentData.matches = tournamentData.matches.filter(match =>
            match.team1 !== teamId && match.team2 !== teamId);
        saveData();
    }  

    // ==================== MATCH MANAGEMENT ====================
    function addNewMatch() {
    const team1Select = document.getElementById('newTeam1');
    const team2Select = document.getElementById('newTeam2');
    const dateInput = document.getElementById('newMatchDate');
    const timeInput = document.getElementById('newMatchTime');

    if (!team1Select || !team2Select) {
        alert('Please open the Admin Panel tab first before adding matches.');
        return;
    }
    const team1 = parseInt(team1Select.value);
    const team2 = parseInt(team2Select.value);

    if (!team1 || !team2) {
        alert('Please select both teams');
        return;
    }

    if (team1 === team2) {
        alert('Please select two different teams');
        return;
    }

    const date = dateInput ? dateInput.value : '';
    const time = timeInput ? timeInput.value : '';

    // If scheduling is required, validate date and time - optional
    // if (!date) { alert('Please select a match date'); return; }
    // if (!time) { alert('Please select a match time'); return; }

    // Check for duplicate match with same teams and date/time if used
    // if (tournamentData.matches.some(m =>
    //     m.team1 === team1 && m.team2 === team2 && m.date === date && m.time === time)) {
    //     alert('This match with same teams and schedule already exists!');
    //     return;
    // }

    tournamentData.matches.push({
        id: tournamentData.nextMatchId++,
        team1,
        team2,
        winner: null,
        completed: false,
        date,  // optional if not used, pass blank string
        time   // optional if not used, pass blank string
    });

    // Clear inputs after adding
    team1Select.value = '';
    team2Select.value = '';
    if (dateInput) dateInput.value = '';
    if (timeInput) timeInput.value = '';

    saveData();
}


    function deleteMatch(matchId) {
        if (!confirm('Are you sure you want to delete this match?')) {
            return;
        }

        const match = tournamentData.matches.find(m => m.id === matchId);
        if (match && match.completed) {
            const winner = tournamentData.teams.find(t => t.id === match.winner);
            const loserId = match.team1 === match.winner ? match.team2 : match.team1;
            const loser = tournamentData.teams.find(t => t.id === loserId);

            if (winner && loser) {
                winner.matches -= 1;
                winner.wins -= 1;
                winner.points -= 2;
                loser.matches -= 1;
                loser.losses -= 1;
            }
        }

        tournamentData.matches =
            tournamentData.matches.filter(match => match.id !== matchId);
        saveData();
    }  

    function updateMatchResult(matchId) {
        const winnerSelect = document.getElementById(`winner-${matchId}`);
        const winnerId = parseInt(winnerSelect.value);
    
        if (!winnerId) {
            alert('Please select a winner');
            return;
        }
    
        const match = tournamentData.matches.find(m => m.id === matchId);
        if (!match) return;
    
        if (match.completed) {
            alert('This match result has already been set and cannot be changed.');
            return;
        }
    
        match.winner = winnerId;
        match.completed = true;
    
        // Save the current date/time (ISO string) for match completion
        match.resultTimestamp = new Date().toISOString();
    
        const winner = tournamentData.teams.find(t => t.id === winnerId);
        const loser = tournamentData.teams.find(t =>
            t.id === (match.team1 === winnerId ? match.team2 : match.team1));
    
        winner.matches += 1;
        winner.wins += 1;
        winner.points += 2;
    
        loser.matches += 1;
        loser.losses += 1;
    
        saveData();
    }


    // ==================== TOURNAMENT OPERATIONS ====================
    function resetTournament() {
        if (confirm('Are you sure you want to reset all tournament data? This will delete all teams, matches, and reset everything!')) {
            tournamentData = {
                teams: [],
                matches: [],
                passwords: tournamentData.passwords,
                nextTeamId: 1,
                nextMatchId: 1
            };
            saveData();
        }
    }  

    // ==================== DISPLAY FUNCTIONS ====================
    function updateAllDisplays() {
        updatePointsTable();
        updateMatchesDisplay();
        updateTeamsList();
        updateLeaderDisplay();
        updateTeamSelects();
    }  

    function updatePointsTable() {
    const tbody = document.getElementById('points-table-body');
    const pointsTable = document.getElementById('points-table');
    const emptyState = document.getElementById('points-empty');

    tbody.innerHTML = '';

    if (tournamentData.teams.length === 0) {
        pointsTable.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    pointsTable.style.display = 'table';
    emptyState.style.display = 'none';

    // Sort teams by points (descending)
    const sortedTeams = [...tournamentData.teams].sort((a, b) => {
        // 1. First sort by points (higher points first)
        if (b.points !== a.points) {
            return b.points - a.points;
        }
        // 2. If points are equal, sort by matches played (fewer matches first)
        return a.matches - b.matches;
    });

        const displayTeams = considerTeamsCount > 0 
        ? sortedTeams.slice(0, considerTeamsCount)
        : sortedTeams;
    
   
    // Group teams by points to determine ranks
    const teamsByPoints = {};
    sortedTeams.forEach(team => {
        if (!teamsByPoints[team.points]) {
            teamsByPoints[team.points] = [];
        }
        teamsByPoints[team.points].push(team);
    });

    // Display teams with proper ranking
    let rank = 1;
    Object.keys(teamsByPoints).sort((a, b) => b - a).forEach(points => {
        const teams = teamsByPoints[points];
        
        teams.forEach((team, index) => {
            const row = document.createElement('tr');
            
            // Determine medal emoji based on rank
            let medal = '';
            if (rank === 1) medal = ' ü•á';
            else if (rank === 2) medal = ' ü•à';
            else if (rank === 3) medal = ' ü•â';
            
            // Set row color based on rank
            let rowClass = '';
            if (rank === 1) rowClass = 'position-1';
            else if (rank === 2) rowClass = 'position-2';
            else if (rank === 3) rowClass = 'position-3';
            
            row.className = rowClass;
            
            row.innerHTML = `
                <td>${rank}${medal}</td>
                <td><strong>${team.name}</strong></td>
                <td>${team.player1}, ${team.player2}</td>
                <td>${team.matches}</td>
                <td>${team.wins}</td>
                <td>${team.losses}</td>
                <td class="team-points"><strong>${team.points}</strong></td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Move to next rank (skip numbers equal to number of teams at current points)
        rank += teams.length;
    });
}

   function updateMatchesDisplay() {
        const container = document.getElementById('matches-container');
        const emptyState = document.getElementById('matches-empty');
        const reorderControls = document.getElementById('reorder-controls');
    
        container.innerHTML = '';
    
        if (tournamentData.matches.length === 0) {
            emptyState.style.display = 'block';
            reorderControls.style.display = 'none';
            return;
        }
    
        emptyState.style.display = 'none';
        reorderControls.style.display =
            currentUser?.role === 'admin' ? 'block' : 'none';
    
        tournamentData.matches.forEach(match => {
            const team1 = tournamentData.teams.find(t => t.id === match.team1);
            const team2 = tournamentData.teams.find(t => t.id === match.team2);
    
            // Handle deleted teams gracefully
            const team1Name = team1 ? team1.name : 'Deleted Team';
            const team2Name = team2 ? team2.name : 'Deleted Team';
            const team1Players = team1 ? `${team1.player1}, ${team1.player2}` : 'N/A';
            const team2Players = team2 ? `${team2.player1}, ${team2.player2}` : 'N/A';
    
            let statusHtml = '<span class="match-status status-pending">‚è≥ Pending</span>';
            if (!team1 || !team2) {
                statusHtml = '<span class="match-status status-abandoned">‚ùå Abandoned</span>';
            } else if (match.completed) {
                statusHtml = '<span class="match-status status-completed">‚úÖ Completed</span>';
            }
    
            // Show winner info if match completed
            let winnerInfo = '';
            if (match.completed) {
                const winnerTeam = tournamentData.teams.find(t => t.id === match.winner);
                if (winnerTeam) {
                    winnerInfo = `<div style="margin-top: 10px; color: var(--success); font-weight: bold;">
                        Winner: ${winnerTeam.name}
                    </div>`;
                }
            }
    
            // Show result timestamp if present
            let resultTimeDisplay = '';
            if (match.resultTimestamp) {
                const dt = new Date(match.resultTimestamp);
                resultTimeDisplay = `<div style="margin-top: 8px; font-weight: 600; color: var(--secondary);">
                    Result recorded: ${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}
                </div>`;
            }
    
            const matchCard = document.createElement('div');
            matchCard.className = 'match-card';
            matchCard.setAttribute('data-match-id', match.id);
            matchCard.draggable = currentUser?.role === 'admin';
    
            matchCard.innerHTML = `
                <div class="drag-handle admin-only" style="display: ${currentUser?.role === 'admin' ? 'block' : 'none'}">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div style="flex: 1;">
                    <div class="match-teams">
                        <span class="team-name">${team1Name}</span>
                        <span class="vs">VS</span>
                        <span class="team-name">${team2Name}</span>
                    </div>
                    <div class="team-players">
                        ${team1Players} vs ${team2Players}
                    </div>
                    ${winnerInfo}
                    ${resultTimeDisplay}
                </div>
                <div class="match-actions">
                    ${statusHtml}
                    ${currentUser?.role === 'admin' && !match.completed && team1 && team2 ? `
                        <select id="winner-${match.id}" class="form-control" style="margin-bottom: 5px;">
                            <option value="">Select Winner</option>
                            <option value="${team1.id}">${team1Name}</option>
                            <option value="${team2.id}">${team2Name}</option>
                        </select>
                        <button class="btn btn-sm" onclick="updateMatchResult(${match.id})">
                            <i class="fas fa-check"></i> Set Result
                        </button>
                    ` : ''}
                    ${currentUser?.role === 'admin' ? `
                        <button class="btn btn-danger btn-sm" onclick="deleteMatch(${match.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    ` : ''}
                </div>
            `;
    
            if (currentUser?.role === 'admin') {
                matchCard.addEventListener('dragstart', handleDragStart);
                matchCard.addEventListener('dragover', handleDragOver);
                matchCard.addEventListener('drop', handleDrop);
                matchCard.addEventListener('dragend', handleDragEnd);
            }
    
            container.appendChild(matchCard);
        });
    }



    function updateTeamsList() {
        const container = document.getElementById('teams-list');
        const emptyState = document.getElementById('teams-empty');

        container.innerHTML = '';

        if (tournamentData.teams.length === 0) {
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        tournamentData.teams.forEach(team => {
            const teamEl = document.createElement('div');
            teamEl.className = 'team-card';
            teamEl.innerHTML = `
                <div>
                    <div style="font-weight: bold;">${team.name}</div>
                    <div class="team-players">${team.player1}, ${team.player2}</div>
                    <div style="margin-top: 5px; font-size: 0.9rem;">
                        <span style="margin-right: 10px;">Matches: ${team.matches}</span>
                        <span style="margin-right: 10px;">Wins: ${team.wins}</span>
                        <span>Points: ${team.points}</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-warning btn-sm" onclick="editTeam(${team.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTeam(${team.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            container.appendChild(teamEl);
        });
    }  

   function updateLeaderDisplay() {
    if (tournamentData.teams.length === 0) {
        document.getElementById('currentLeader').innerHTML = 'No teams yet. Add teams to start the tournament!';
        return;
    }
    
    // Sort teams by points
    const sortedTeams = [...tournamentData.teams].sort((a, b) => {
        // 1. First sort by points (higher points first)
        if (b.points !== a.points) {
            return b.points - a.points;
        }
        // 2. If points are equal, sort by matches played (fewer matches first)
        return a.matches - b.matches;
    });

       const displayTeams = considerTeamsCount > 0 
        ? sortedTeams.slice(0, considerTeamsCount)
        : sortedTeams;
    
    // Get highest points
    const highestPoints = sortedTeams[0].points;
    
    // Find all teams with highest points
    const topTeams = sortedTeams.filter(team => team.points === highestPoints);
    
    let leaderHTML = '';
    
    if (topTeams.length === 1) {
        // Single leader
        const leader = topTeams[0];
        leaderHTML = `
            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeb99 100%); border-radius: 10px; margin-bottom: 15px;">
                <span style="font-size: 2rem;">ü•á</span>
                <h3 style="margin: 10px 0; color: #856404;">TOURNAMENT LEADER</h3>
                <strong style="font-size: 1.5rem; color: #856404;">${leader.name}</strong>
                <div style="margin-top: 10px;">
                    <span style="background: #856404; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                        ${leader.points} POINTS
                    </span>
                </div>
                <div style="margin-top: 10px; color: #856404;">
                    ${leader.matches} matches ‚Ä¢ ${leader.wins} wins ‚Ä¢ ${leader.losses} losses
                </div>
            </div>
        `;
    } else {
        // Multiple teams tied for first
        leaderHTML = `
            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeb99 100%); border-radius: 10px; margin-bottom: 15px;">
                <span style="font-size: 2rem;">ü•á</span>
                <h3 style="margin: 10px 0; color: #856404;">JOINT LEADERS (${topTeams.length} TEAMS)</h3>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
        `;
        
        topTeams.forEach(team => {
            leaderHTML += `
                <div style="background: white; padding: 10px 15px; border-radius: 8px; min-width: 150px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <strong style="color: #856404;">${team.name}</strong>
                    <div style="margin-top: 5px;">
                        <span style="background: #856404; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.9rem;">
                            ${team.points} pts
                        </span>
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        ${team.wins}W ${team.losses}L
                    </div>
                </div>
            `;
        });
        
        leaderHTML += `
                </div>
                <div style="margin-top: 15px; color: #856404; font-style: italic;">
                    All tied with ${highestPoints} points
                </div>
            </div>
        `;
    }
    
    // Show 2nd and 3rd place if they exist and are not tied for 1st
    const secondPlaceTeams = sortedTeams.filter(team => 
        team.points < highestPoints && 
        team.points === sortedTeams[topTeams.length]?.points
    );
    
    const thirdPlaceTeams = sortedTeams.filter(team => 
        team.points < highestPoints && 
        team.points < secondPlaceTeams[0]?.points && 
        team.points === sortedTeams[topTeams.length + secondPlaceTeams.length]?.points
    );
    
    if (secondPlaceTeams.length > 0) {
        leaderHTML += `
            <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <span style="color: #6c757d;">ü•à</span>
                <strong style="color: #6c757d;">2nd Place:</strong>
                ${secondPlaceTeams.map(team => 
                    `<span style="margin-left: 10px;">${team.name} (${team.points} pts)</span>`
                ).join('')}
            </div>
        `;
    }
    
    if (thirdPlaceTeams.length > 0) {
        leaderHTML += `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <span style="color: #cd7f32;">ü•â</span>
                <strong style="color: #cd7f32;">3rd Place:</strong>
                ${thirdPlaceTeams.map(team => 
                    `<span style="margin-left: 10px;">${team.name} (${team.points} pts)</span>`
                ).join('')}
            </div>
        `;
    }
    
    document.getElementById('currentLeader').innerHTML = leaderHTML;
}

    function updateTeamSelects() {
        const selects = ['newTeam1', 'newTeam2'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Team</option>';
            tournamentData.teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                select.appendChild(option);
            });
        });
    }  

    // ==================== DRAG & DROP ====================
    function handleDragStart(e) {
        isDragging = true;
        draggedElement = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.style.opacity = '0.4';
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();

        if (draggedElement !== this) {
            const parent = this.parentNode;
            const children = Array.from(parent.children);
            const fromIndex = children.indexOf(draggedElement);
            const toIndex = children.indexOf(this);

            parent.insertBefore(draggedElement, toIndex > fromIndex ? this.nextSibling : this);

            const movedMatch = tournamentData.matches.splice(fromIndex, 1)[0];
            tournamentData.matches.splice(toIndex, 0, movedMatch);
        }

        return false;
    }

    function handleDragEnd() {
        this.style.opacity = '1';
        isDragging = false;
        draggedElement = null;
    }

    function saveMatchOrder() {
        saveData();
    }  

    // ==================== EXPORT / IMPORT ====================
    function downloadPointsTable() {
        if (tournamentData.teams.length === 0) {
            alert('No teams to download');
            return;
        }

        const sortedTeams = [...tournamentData.teams].sort((a, b) => {
        // 1. First sort by points (higher points first)
        if (b.points !== a.points) {
            return b.points - a.points;
        }
        // 2. If points are equal, sort by matches played (fewer matches first)
        return a.matches - b.matches;
    });

        const data = sortedTeams.map((team, index) => ({
            Position: index + 1,
            Team: team.name,
            'Player 1': team.player1,
            'Player 2': team.player2,
            Matches: team.matches,
            Wins: team.wins,
            Losses: team.losses,
            Points: team.points
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Points Table");
        XLSX.writeFile(wb, 'ludo_tournament_points.xlsx');
    }  

    function exportTournamentData() {
        const dataStr = JSON.stringify(tournamentData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ludo_tournament_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }  

    function importTournamentData() {
        document.getElementById('importFile').click();
    }

    document.getElementById('importFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    tournamentData = importedData;
                    saveData();
                    alert('Tournament data imported successfully!');
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }
    });  

    // ==================== TABS & ROLE SELECTOR ====================
  function showTab(tabName) {

       if (tabName === 'admin') {
        if (currentUser?.role !== 'admin') {
            alert('Admin access required!');
            return;
        }
        updateAdminUIState(); 
    }
      
            if (tabName === 'admin' && currentUser?.role !== 'admin') {
                alert('Admin access required!');
                return;
            }
        
            // Remove active class from all tab content and buttons
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
        
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        
            // Add active class to selected tab content
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
        
            // Add active class to the button corresponding to the tab
            // Assumes button ID is tabName + 'Tab' (e.g., 'welcome' -> 'welcomeTab')
            const tabButton = document.getElementById(tabName + 'Tab');
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }




    function setupEventListeners() {
        document.getElementById('viewerRole').addEventListener('click', () => selectRole('viewer'));
        document.getElementById('adminRole').addEventListener('click', () => selectRole('admin'));
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }  

    function selectRole(role) {
        document.getElementById('viewerRole').classList.toggle('active', role === 'viewer');
        document.getElementById('adminRole').classList.toggle('active', role === 'admin');
    }  

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        loadData();
        checkAuthentication();
    });  
    </script>
</body>
</html>
