<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Boys LUDO Tournament</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd8;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #e53e3e;
            --warning: #ed8936;
            --dark: #2d3748;
            --light: #f7fafc;
            --gray: #718096;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
        }

        .role-selector {
            display: flex;
            margin-bottom: 30px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .role-btn.active {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #dd771c;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .points-table th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .points-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .points-table tr:nth-child(even) {
            background: #f7fafc;
        }

        .points-table tr:hover {
            background: #edf2f7;
        }

        .team-points {
            font-weight: bold;
            color: var(--dark);
        }

        .admin-controls {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .match-card {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-teams {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .team-name {
            font-weight: 600;
            color: var(--dark);
        }

        .vs {
            color: var(--gray);
            font-weight: bold;
        }

        .match-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fed7d7;
            color: var(--danger);
        }

        .status-completed {
            background: #c6f6d5;
            color: var(--success);
        }

        .status-abandoned {
            background: #e2e8f0;
            color: var(--gray);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .team-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-players {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .drag-handle {
            cursor: move;
            color: var(--gray);
            padding: 5px;
        }

        .match-actions {
            display: flex;
            gap: 5px;
            flex-direction: column;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .points-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .points-table {
                min-width: 700px;
                font-size: 0.85rem;
            }

            .points-table th,
            .points-table td {
                padding: 12px 8px;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .match-card {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }

            .match-teams {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .team-players {
                font-size: 0.8rem;
            }

            .team-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .form-control {
                font-size: 16px;
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            .action-buttons .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .points-table {
                min-width: 600px;
                font-size: 0.8rem;
            }

            .points-table th,
            .points-table td {
                padding: 10px 6px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .login-box {
                padding: 25px 20px;
                margin: 10px;
            }

            .tab-btn {
                padding: 10px 15px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="container login-container" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">üé≤ MC Boys LUDO</h1>
            <p class="login-subtitle">Tournament Management System</p>

            <div class="role-selector">
                <button class="role-btn active" id="viewerRole">Viewer</button>
                <button class="role-btn" id="adminRole">Admin</button>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
            </div>

            <button class="btn" id="loginBtn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>

            <div id="loginHelp" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading passwords from database...</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container app-container" id="appContainer">
        <div class="header">
            <div>
                <h1>üèÜ MC Boys LUDO Tournament</h1>
                <p>Season -1 2025 - Competitive LUDO Championship</p>
            </div>
            <div class="user-info">
                <span id="connectionStatus" style="background: var(--success); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: none;">
                    <i class="fas fa-cloud"></i> Real-Time
                </span>
                <span id="userRoleDisplay"></span>
                <button class="btn btn-warning" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn" id="welcomeTab" onclick="showTab('welcome')">
                <i class="fas fa-home"></i> Welcome
            </button>
            <button class="tab-btn active" id="pointsTab" onclick="showTab('points')">
                <i class="fas fa-table"></i> Points Table
            </button>
            <button class="tab-btn" id="scheduleTab" onclick="showTab('schedule')">
                <i class="fas fa-calendar-alt"></i> Matches
            </button>
            <button class="tab-btn admin-only" id="adminTab" onclick="showTab('admin')">
                <i class="fas fa-cogs"></i> Admin Panel
            </button>
        </div>

        <!-- Welcome Tab -->
        <div id="welcome" class="tab-content">
            <h2>üé≤ Welcome to MC Boys LUDO Tournament!</h2>
            <p style="margin: 20px 0; font-size: 1.1rem; line-height: 1.6;">
                Get ready for an exciting LUDO tournament featuring competitive teams.
                Follow the matches, track points, and see who emerges as the ultimate champion!
            </p>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-info-circle"></i> Tournament Rules</h3>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>Win: 2 points</li>
                    <li>Lose: 0 points</li>
                    <li>No draws - every match has a winner</li>
                    <li>Multiple teams competing for the championship</li>
                </ul>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-trophy"></i> Current Leader</h3>
                <div id="currentLeader" style="font-size: 1.2rem; font-weight: bold; color: var(--primary); margin: 10px 0;">... No teams yet
                </div>
            </div>
        </div>

        <!-- Points Table Tab -->
        <div id="points" class="tab-content active">
            <h2>üìä Tournament Points Table</h2>

            <div id="points-empty" class="empty-state" style="display: none;">
                <i class="fas fa-users"></i>
                <h3>No Teams Yet</h3>
                <p>Add teams in the Admin Panel to get started</p>
            </div>

            <div class="points-table-container">
                <table class="points-table" id="points-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>Players</th>
                            <th>Matches</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="points-table-body">
                        <!-- Points table will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success admin-only" onclick="downloadPointsTable()">
                    <i class="fas fa-download"></i> Download Excel
                </button>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <h2>üìÖ Tournament Matches</h2>

            <div id="matches-empty" class="empty-state" style="display: none;">
                <i class="fas fa-calendar-times"></i>
                <h3>No Matches Scheduled</h3>
                <p>Add matches between teams to create the tournament schedule</p>
            </div>

            <div class="admin-controls admin-only">
                <h3><i class="fas fa-plus-circle"></i> Add New Match</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Team 1</label>
                        <select id="newTeam1" class="form-control">
                            <option value="">Select Team 1</option>
                            <!-- Teams will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Team 2</label>
                        <select id="newTeam2" class="form-control">
                            <option value="">Select Team 2</option>
                            <!-- Teams will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="newMatchDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="newMatchTime" class="form-control">
                    </div>

                </div>
                <button class="btn" onclick="addNewMatch()">
                    <i class="fas fa-plus"></i> Add Match
                </button>
            </div>

            <div class="admin-controls admin-only" id="reorder-controls" style="display: none;">
                <h3><i class="fas fa-sort"></i> Reorder Matches</h3>
                <p>Drag and drop matches to rearrange the schedule</p>
                <button class="btn btn-warning" onclick="saveMatchOrder()">
                    <i class="fas fa-save"></i> Save New Order
                </button>
            </div>

            <div id="matches-container">
                <!-- Matches will be populated by JavaScript -->
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin" class="tab-content">
            <h2>‚öôÔ∏è Admin Panel</h2>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-users"></i> Manage Teams</h3>
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="newTeamName" class="form-control" placeholder="Enter team name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="player1Name" class="form-control" placeholder="Player 1 name">
                    </div>
                    <div class="form-group">
                        <input type="text" id="player2Name" class="form-control" placeholder="Player 2 name">
                    </div>
                </div>
                <button class="btn" onclick="addNewTeam()">
                    <i class="fas fa-plus"></i> Add Team
                </button>

                <div id="teams-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-user-plus"></i>
                    <h3>No Teams Added Yet</h3>
                    <p>Start by adding your first team above</p>
                </div>

                <div id="teams-list" style="margin-top: 15px;">
                    <!-- Teams list will be populated by JavaScript -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-key"></i> Password Management</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Admin Password</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="New admin password">
                    </div>
                    <div class="form-group">
                        <label>Viewer Password</label>
                        <input type="password" id="viewerPassword" class="form-control" placeholder="New viewer password">
                    </div>
                </div>
                <button class="btn btn-warning" onclick="updatePasswords()">
                    <i class="fas fa-save"></i> Update Passwords
                </button>
                <p style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> Passwords are securely stored in the database
                </p>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-database"></i> Tournament Data</h3>
                <button class="btn btn-danger" onclick="resetTournament()">
                    <i class="fas fa-trash"></i> Reset Tournament
                </button>
                <button class="btn" onclick="exportTournamentData()" style="margin-left: 10px;">
                    <i class="fas fa-file-export"></i> Export Data
                </button>
                <button class="btn" onclick="importTournamentData()" style="margin-left: 10px;">
                    <i class="fas fa-file-import"></i> Import Data
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyAQDJbWsCDbgKMdmMZ8Rz_QmTo-kW6ZdHM",
      authDomain: "ludo-tournament-d6e32.firebaseapp.com",
      projectId: "ludo-tournament-d6e32",
      storageBucket: "ludo-tournament-d6e32.firebasestorage.app",
      messagingSenderId: "245161933582",
      appId: "1:245161933582:web:9d18c5bfc74a41f705b55f",
      measurementId: "G-3R2EZR2HK9"
    };  

    let db = null;
    let isFirebaseConnected = false;

    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isFirebaseConnected = true;
        console.log('Firebase connected');
        document.getElementById('connectionStatus').style.display = 'inline-block';
    } catch (e) {
        console.log('Firebase init failed, using local storage instead');
    }  

    // ==================== TOURNAMENT DATA STRUCTURE ====================
    let tournamentData = {
        teams: [],
        matches: [],
        passwords: { admin: "", viewer: "" },
        nextTeamId: 1,
        nextMatchId: 1
    };

    let currentUser = null;
    let isDragging = false;
    let draggedElement = null;
    let passwordsLoaded = false;  

    // ==================== FIREBASE DATA MANAGEMENT ====================
    async function saveData() {
        if (db && isFirebaseConnected) {
            try {
                await db.collection('tournament').doc('data').set(tournamentData);
                console.log('‚úÖ Data saved to Firebase');
            } catch (error) {
                console.error('‚ùå Firebase error:', error);
                localStorage.setItem('ludoTournamentData', JSON.stringify(tournamentData));
            }
        } else {
            localStorage.setItem('ludoTournamentData', JSON.stringify(tournamentData));
        }
        updateAllDisplays();
    }  

    function loadData() {
        if (db && isFirebaseConnected) {
            showLoadingMessage('Loading from database...');

            db.collection('tournament').doc('data').get().then((doc) => {
                if (doc.exists) {
                    tournamentData = doc.data();
                    passwordsLoaded = true;
                    hideLoadingMessage();
                    console.log('‚úÖ Passwords loaded from Firebase');
                    updateAllDisplays();
                } else {
                    initializeFirstTimeData();
                }
            }).catch((error) => {
                console.error('Error loading data:', error);
                loadFromLocalStorage();
            });
        } else {
            loadFromLocalStorage();
        }
    }  

    function initializeFirstTimeData() {
        tournamentData.passwords = {
            admin: "admin123",
            viewer: "view123"
        };
        passwordsLoaded = true;
        saveData();
        hideLoadingMessage();
        console.log('üéØ First-time data initialized with default passwords');
    }  

    function loadFromLocalStorage() {
        const saved = localStorage.getItem('ludoTournamentData');
        if (saved) {
            tournamentData = JSON.parse(saved);
            passwordsLoaded = true;
        } else {
            tournamentData.passwords = { admin: "admin123", viewer: "view123" };
            passwordsLoaded = true;
            saveData();
        }
        hideLoadingMessage();
        updateAllDisplays();
    }  

    function showLoadingMessage(message) {
        document.getElementById('loginHelp').style.display = 'block';
        document.getElementById('loginHelp').innerHTML =
            `<i class="fas fa-spinner fa-spin"></i><p>${message}</p>`;
    }

    function hideLoadingMessage() {
        document.getElementById('loginHelp').style.display = 'none';
    }

    // ==================== AUTHENTICATION SYSTEM ====================
    function checkAuthentication() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            if (passwordsLoaded) {
                showApp();
            } else {
                setTimeout(checkAuthentication, 100);
            }
        }
    }  

    function login() {
        if (!passwordsLoaded) {
            alert('System still loading. Please wait...');
            return;
        }

        const role = document.getElementById('viewerRole').classList.contains('active')
            ? 'viewer' : 'admin';
        const password = document.getElementById('password').value.trim();
        const storedPassword = tournamentData.passwords[role];

        if (!storedPassword) {
            alert('Password not set in database. Please contact administrator.');
            return;
        }

        if (password === storedPassword) {
            currentUser = { role, loginTime: new Date().toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
        } else {
            alert('Invalid password! Please try again.');
        }
    }  

    function logout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showLogin();
    }

    function showLogin() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('password').value = '';
        selectRole('viewer'); // reset role on logout
    }  

    function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userRoleDisplay').textContent =
        `Logged in as ${currentUser.role}`;

    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
    });
    document.getElementById('adminTab').style.display =
        currentUser.role === 'admin' ? 'flex' : 'none';

    // force default tab per role
    if (currentUser.role === 'admin') {
        showTab('admin');
    } else {
        showTab('welcome');
    }

    updateAllDisplays();
}


    // ==================== PASSWORD MANAGEMENT ====================
    function updatePasswords() {
        const adminPass = document.getElementById('adminPassword').value.trim();
        const viewerPass = document.getElementById('viewerPassword').value.trim();

        if (!adminPass && !viewerPass) {
            alert('Please enter at least one new password');
            return;
        }

        if (adminPass && adminPass.length < 4) {
            alert('Admin password must be at least 4 characters long');
            return;
        }
        if (viewerPass && viewerPass.length < 4) {
            alert('Viewer password must be at least 4 characters long');
            return;
        }

        if (adminPass) tournamentData.passwords.admin = adminPass;
        if (viewerPass) tournamentData.passwords.viewer = viewerPass;

        document.getElementById('adminPassword').value = '';
        document.getElementById('viewerPassword').value = '';

        saveData();
        alert('Passwords updated successfully in database!');
    }  

    // ==================== TEAM MANAGEMENT ====================
    function addNewTeam() {
        const nameInput = document.getElementById('newTeamName');
        const player1Input = document.getElementById('player1Name');
        const player2Input = document.getElementById('player2Name');

        const name = nameInput.value.trim();
        const player1 = player1Input.value.trim();
        const player2 = player2Input.value.trim();

        if (!name || !player1 || !player2) {
            alert('Please enter team name and both player names');
            return;
        }

        if (tournamentData.teams.some(team =>
            team.name.toLowerCase() === name.toLowerCase())) {
            alert('Team name already exists! Please choose a different name.');
            return;
        }

        tournamentData.teams.push({
            id: tournamentData.nextTeamId++,
            name,
            player1,
            player2,
            matches: 0,
            wins: 0,
            losses: 0,
            points: 0
        });

        nameInput.value = '';
        player1Input.value = '';
        player2Input.value = '';
        saveData();
    }  

    function editTeam(teamId) {
        const team = tournamentData.teams.find(t => t.id === teamId);
        if (!team) return;

        const newName = prompt('Enter new team name:', team.name);
        if (newName === null) return;

        const newPlayer1 = prompt('Enter Player 1 name:', team.player1);
        if (newPlayer1 === null) return;

        const newPlayer2 = prompt('Enter Player 2 name:', team.player2);
        if (newPlayer2 === null) return;

        if (tournamentData.teams.some(t =>
            t.id !== teamId && t.name.toLowerCase() === newName.toLowerCase())) {
            alert('Team name already exists! Please choose a different name.');
            return;
        }

        team.name = newName.trim();
        team.player1 = newPlayer1.trim();
        team.player2 = newPlayer2.trim();

        saveData();
    }  

    function deleteTeam(teamId) {
        if (!confirm('Are you sure you want to delete this team? This will also delete all matches involving this team.')) {
            return;
        }

        tournamentData.teams = tournamentData.teams.filter(team => team.id !== teamId);
        tournamentData.matches = tournamentData.matches.filter(match =>
            match.team1 !== teamId && match.team2 !== teamId);
        saveData();
    }  

    // ==================== MATCH MANAGEMENT ====================
    function addNewMatch() {
        const team1 = parseInt(document.getElementById('newTeam1').value);
        const team2 = parseInt(document.getElementById('newTeam2').value);
        const date = document.getElementById('newMatchDate').value; // format: "YYYY-MM-DD"
        const time = document.getElementById('newMatchTime').value; // format: "HH:mm"
    
        if (!team1 || !team2) {
            alert('Please select both teams');
            return;
        }
    
        if (team1 === team2) {
            alert('Please select two different teams');
            return;
        }
    
        if (!date) {
            alert('Please select a match date');
            return;
        }
    
        if (!time) {
            alert('Please select a match time');
            return;
        }
    
        if (tournamentData.matches.some(m =>
            (m.team1 === team1 && m.team2 === team2 && m.date === date && m.time === time))) {
            alert('This match with same teams and schedule already exists!');
            return;
        }
    
        tournamentData.matches.push({
            id: tournamentData.nextMatchId++,
            team1,
            team2,
            winner: null,
            completed: false,
            date,  // store date string
            time   // store time string
        });
    
        // Clear inputs after adding
        document.getElementById('newTeam1').value = '';
        document.getElementById('newTeam2').value = '';
        document.getElementById('newMatchDate').value = '';
        document.getElementById('newMatchTime').value = '';
    
        saveData();
    }


    function deleteMatch(matchId) {
        if (!confirm('Are you sure you want to delete this match?')) {
            return;
        }

        const match = tournamentData.matches.find(m => m.id === matchId);
        if (match && match.completed) {
            const winner = tournamentData.teams.find(t => t.id === match.winner);
            const loserId = match.team1 === match.winner ? match.team2 : match.team1;
            const loser = tournamentData.teams.find(t => t.id === loserId);

            if (winner && loser) {
                winner.matches -= 1;
                winner.wins -= 1;
                winner.points -= 2;
                loser.matches -= 1;
                loser.losses -= 1;
            }
        }

        tournamentData.matches =
            tournamentData.matches.filter(match => match.id !== matchId);
        saveData();
    }  

    function updateMatchResult(matchId) {
        const winnerSelect = document.getElementById(`winner-${matchId}`);
        const winnerId = parseInt(winnerSelect.value);

        if (!winnerId) {
            alert('Please select a winner');
            return;
        }

        const match = tournamentData.matches.find(m => m.id === matchId);
        if (!match) return;

        if (match.completed) {
            alert('This match result has already been set and cannot be changed.');
            return;
        }

        match.winner = winnerId;
        match.completed = true;

        const winner = tournamentData.teams.find(t => t.id === winnerId);
        const loser = tournamentData.teams.find(t =>
            t.id === (match.team1 === winnerId ? match.team2 : match.team1));

        winner.matches += 1;
        winner.wins += 1;
        winner.points += 2;

        loser.matches += 1;
        loser.losses += 1;

        saveData();
    }  

    // ==================== TOURNAMENT OPERATIONS ====================
    function resetTournament() {
        if (confirm('Are you sure you want to reset all tournament data? This will delete all teams, matches, and reset everything!')) {
            tournamentData = {
                teams: [],
                matches: [],
                passwords: tournamentData.passwords,
                nextTeamId: 1,
                nextMatchId: 1
            };
            saveData();
        }
    }  

    // ==================== DISPLAY FUNCTIONS ====================
    function updateAllDisplays() {
        updatePointsTable();
        updateMatchesDisplay();
        updateTeamsList();
        updateLeaderDisplay();
        updateTeamSelects();
    }  

    function updatePointsTable() {
        const tbody = document.getElementById('points-table-body');
        const pointsTable = document.getElementById('points-table');
        const emptyState = document.getElementById('points-empty');

        tbody.innerHTML = '';

        if (tournamentData.teams.length === 0) {
            pointsTable.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        pointsTable.style.display = 'table';
        emptyState.style.display = 'none';

        const sortedTeams = [...tournamentData.teams]
            .sort((a, b) => b.points - a.points);

        sortedTeams.forEach((team, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${team.name}</td>
                <td>${team.player1}, ${team.player2}</td>
                <td>${team.matches}</td>
                <td>${team.wins}</td>
                <td>${team.losses}</td>
                <td class="team-points">${team.points}</td>
            `;
            tbody.appendChild(row);
        });
    }  

   function updateMatchesDisplay() {
        const container = document.getElementById('matches-container');
        const emptyState = document.getElementById('matches-empty');
        const reorderControls = document.getElementById('reorder-controls');
    
        container.innerHTML = '';
    
        if (tournamentData.matches.length === 0) {
            emptyState.style.display = 'block';
            reorderControls.style.display = 'none';
            return;
        }
    
        emptyState.style.display = 'none';
        reorderControls.style.display =
            currentUser?.role === 'admin' ? 'block' : 'none';
    
        tournamentData.matches.forEach(match => {
            const team1 = tournamentData.teams.find(t => t.id === match.team1);
            const team2 = tournamentData.teams.find(t => t.id === match.team2);
    
            let dateTimeDisplay = '';
            if (match.date && match.time) {
                dateTimeDisplay = `<div style="margin-top: 8px; font-weight: 600; color: var(--secondary);">
                    Scheduled: ${match.date} ${match.time}
                </div>`;
            }
    
            const matchCard = document.createElement('div');
            matchCard.className = 'match-card';
            // include dateTimeDisplay in innerHTML like:
            matchCard.innerHTML = `
                <div class="match-teams">
                    <span class="team-name">${team1 ? team1.name : "Deleted Team"}</span>
                    <span class="vs">VS</span>
                    <span class="team-name">${team2 ? team2.name : "Deleted Team"}</span>
                </div>
                <div class="team-players">
                    ${team1 ? `${team1.player1}, ${team1.player2}` : "N/A"} vs ${team2 ? `${team2.player1}, ${team2.player2}` : "N/A"}
                </div>
                ${dateTimeDisplay}
                ... // rest of your match card content
            `;
    
            container.appendChild(matchCard);
        });
    }


    function updateTeamsList() {
        const container = document.getElementById('teams-list');
        const emptyState = document.getElementById('teams-empty');

        container.innerHTML = '';

        if (tournamentData.teams.length === 0) {
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        tournamentData.teams.forEach(team => {
            const teamEl = document.createElement('div');
            teamEl.className = 'team-card';
            teamEl.innerHTML = `
                <div>
                    <div style="font-weight: bold;">${team.name}</div>
                    <div class="team-players">${team.player1}, ${team.player2}</div>
                    <div style="margin-top: 5px; font-size: 0.9rem;">
                        <span style="margin-right: 10px;">Matches: ${team.matches}</span>
                        <span style="margin-right: 10px;">Wins: ${team.wins}</span>
                        <span>Points: ${team.points}</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-warning btn-sm" onclick="editTeam(${team.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTeam(${team.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            container.appendChild(teamEl);
        });
    }  

    function updateLeaderDisplay() {
        const sortedTeams = [...tournamentData.teams].sort((a, b) => b.points - a.points);
        const leader = sortedTeams[0];
        document.getElementById('currentLeader').textContent =
            leader ? `${leader.name} (${leader.points} points)` : 'No teams yet';
    }  

    function updateTeamSelects() {
        const selects = ['newTeam1', 'newTeam2'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Team</option>';
            tournamentData.teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                select.appendChild(option);
            });
        });
    }  

    // ==================== DRAG & DROP ====================
    function handleDragStart(e) {
        isDragging = true;
        draggedElement = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.style.opacity = '0.4';
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();

        if (draggedElement !== this) {
            const parent = this.parentNode;
            const children = Array.from(parent.children);
            const fromIndex = children.indexOf(draggedElement);
            const toIndex = children.indexOf(this);

            parent.insertBefore(draggedElement, toIndex > fromIndex ? this.nextSibling : this);

            const movedMatch = tournamentData.matches.splice(fromIndex, 1)[0];
            tournamentData.matches.splice(toIndex, 0, movedMatch);
        }

        return false;
    }

    function handleDragEnd() {
        this.style.opacity = '1';
        isDragging = false;
        draggedElement = null;
    }

    function saveMatchOrder() {
        saveData();
    }  

    // ==================== EXPORT / IMPORT ====================
    function downloadPointsTable() {
        if (tournamentData.teams.length === 0) {
            alert('No teams to download');
            return;
        }

        const sortedTeams = [...tournamentData.teams].sort((a, b) => b.points - a.points);

        const data = sortedTeams.map((team, index) => ({
            Position: index + 1,
            Team: team.name,
            'Player 1': team.player1,
            'Player 2': team.player2,
            Matches: team.matches,
            Wins: team.wins,
            Losses: team.losses,
            Points: team.points
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Points Table");
        XLSX.writeFile(wb, 'ludo_tournament_points.xlsx');
    }  

    function exportTournamentData() {
        const dataStr = JSON.stringify(tournamentData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ludo_tournament_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }  

    function importTournamentData() {
        document.getElementById('importFile').click();
    }

    document.getElementById('importFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    tournamentData = importedData;
                    saveData();
                    alert('Tournament data imported successfully!');
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                }
            };
            reader.readAsText(file);
        }
    });  

    // ==================== TABS & ROLE SELECTOR ====================
    function showTab(event, tabName) {
        if (tabName === 'admin' && currentUser?.role !== 'admin') {
            alert('Admin access required!');
            return;
        }
    
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    
        document.getElementById(tabName).classList.add('active');
        event.currentTarget.classList.add('active');
    }



    function setupEventListeners() {
        document.getElementById('viewerRole').addEventListener('click', () => selectRole('viewer'));
        document.getElementById('adminRole').addEventListener('click', () => selectRole('admin'));
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }  

    function selectRole(role) {
        document.getElementById('viewerRole').classList.toggle('active', role === 'viewer');
        document.getElementById('adminRole').classList.toggle('active', role === 'admin');
    }  

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        loadData();
        checkAuthentication();
    });  
    </script>
</body>
</html>
