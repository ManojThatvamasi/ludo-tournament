
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Boys LUDO Tournament</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd8;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #e53e3e;
            --warning: #ed8936;
            --info: #4299e1;
            --dark: #2d3748;
            --light: #f7fafc;
            --gray: #718096;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 10px;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 10px;
        }

        .login-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .role-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .role-btn {
            flex: 1;
            padding: 10px;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .role-btn.active {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #dd771c;
        }

        .btn-info {
            background: var(--info);
        }

        .btn-info:hover {
            background: #3182ce;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            flex-wrap: wrap;
            justify-content: center;
        }

        .season-selector {
            margin: 15px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .season-selector label {
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .season-selector select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            flex: 1;
            min-width: 0;
            font-size: 0.95rem;
        }

        .season-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .season-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .season-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .season-stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
            min-width: 60px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tab-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .points-table-container {
            overflow-x: auto;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .points-table th {
            background: var(--dark);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .points-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .points-table tr:nth-child(even) {
            background: #f7fafc;
        }

        .points-table tr:hover {
            background: #edf2f7;
        }

        .team-points {
            font-weight: bold;
            color: var(--dark);
        }

        .admin-controls {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .match-card {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-teams {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .team-name {
            font-weight: 600;
            color: var(--dark);
            text-align: center;
        }

        .vs {
            color: var(--gray);
            font-weight: bold;
        }

        .match-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .status-pending {
            background: #fed7d7;
            color: var(--danger);
        }

        .status-completed {
            background: #c6f6d5;
            color: var(--success);
        }

        .status-abandoned {
            background: #e2e8f0;
            color: var(--gray);
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .form-row {
                flex-direction: row;
            }
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .team-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 480px) {
            .team-card {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .team-players {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 3px;
        }

        .match-actions {
            display: flex;
            gap: 5px;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        @media (min-width: 480px) {
            .match-actions {
                flex-direction: row;
                align-items: center;
                margin-top: 0;
            }
        }

        /* Position colors */
        .position-1 {
            background: linear-gradient(90deg, #fff9db 0%, #fff3cd 100%) !important;
            border-left: 4px solid gold !important;
        }
        
        .position-2 {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%) !important;
            border-left: 4px solid silver !important;
        }
        
        .position-3 {
            background: linear-gradient(90deg, #fff3e6 0%, #ffe8cc 100%) !important;
            border-left: 4px solid #cd7f32 !important;
        }
        
        /* Season Badge */
        .season-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Season Creation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .season-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            .season-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        /* Responsive fixes */
        @media (max-width: 768px) {
            .season-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .season-selector select {
                width: 100%;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .tab-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .tab-content {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 20px 15px;
            }
            
            .login-title {
                font-size: 1.5rem;
            }
            
            .header {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 8px;
            }
            
            .points-table {
                min-width: 500px;
                font-size: 0.8rem;
            }
            
            .points-table th,
            .points-table td {
                padding: 8px 6px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 15px;
            color: var(--gray);
        }

        /* Connection Status */
        #connectionStatus {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="container login-container" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">üé≤ MC Boys LUDO</h1>
            <p class="login-subtitle">Multi-Season Tournament Management</p>

            <div class="role-selector">
                <button class="role-btn active" id="viewerRole">Viewer</button>
                <button class="role-btn" id="adminRole">Admin</button>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
            </div>

            <button class="btn" id="loginBtn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>

            <div id="loginHelp" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading passwords from database...</p>
            </div>
        </div>
    </div>

    <!-- Season Creation Modal -->
    <div class="modal-overlay" id="seasonModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-plus-circle"></i> Create New Season</h2>
                <button class="modal-close" onclick="closeSeasonModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Season Name</label>
                <input type="text" id="newSeasonName" class="form-control" placeholder="e.g., Summer 2024, Championship League">
            </div>
            
            <div class="form-group">
                <label>Season Number</label>
                <input type="number" id="newSeasonNumber" class="form-control" placeholder="e.g., 1, 2, 3" min="1">
            </div>
            
            <div class="form-group">
                <label>Description (Optional)</label>
                <textarea id="newSeasonDescription" class="form-control" rows="3" placeholder="Describe this season..."></textarea>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="createNewSeason()">
                    <i class="fas fa-plus"></i> Create Season
                </button>
                <button class="btn btn-warning" onclick="closeSeasonModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container app-container" id="appContainer">
        <div class="header">
            <div>
                <h1>üèÜ MC Boys LUDO Tournament</h1>
                <p>Multi-Season Championship Management</p>
            </div>
            <div class="user-info">
                <span id="connectionStatus" style="display: none;">
                    <i class="fas fa-cloud"></i> Real-Time
                </span>
                <span id="userRoleDisplay"></span>
                <button class="btn btn-warning btn-sm" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Season Selector -->
        <div class="season-selector">
            <label><i class="fas fa-calendar-alt"></i> Season:</label>
            <select id="seasonSelect" onchange="loadSeasonData()">
                <option value="">Loading seasons...</option>
            </select>
            
            <button class="btn btn-success" onclick="openSeasonModal()" id="newSeasonBtn">
                <i class="fas fa-plus"></i> New
            </button>
            
            <button class="btn btn-info" onclick="showTab('seasons')">
                <i class="fas fa-list"></i> All
            </button>
        </div>

        <div class="tabs">
            <button class="tab-btn" id="welcomeTab" onclick="showTab('welcome')">
                <i class="fas fa-home"></i> Welcome
            </button>
            <button class="tab-btn admin-only" id="seasonsTab" onclick="showTab('seasons')">
                <i class="fas fa-calendar"></i> Seasons
            </button>
            <button class="tab-btn active" id="pointsTab" onclick="showTab('points')">
                <i class="fas fa-table"></i> Points
            </button>
            <button class="tab-btn" id="scheduleTab" onclick="showTab('schedule')">
                <i class="fas fa-calendar-alt"></i> Matches
            </button>
            <button class="tab-btn admin-only" id="adminTab" onclick="showTab('admin')">
                <i class="fas fa-cogs"></i> Admin
            </button>
        </div>

        <!-- Welcome Tab -->
        <div id="welcome" class="tab-content">
            <h2>üé≤ Welcome to MC Boys LUDO Tournament!</h2>
            <p style="margin: 15px 0; font-size: 1rem; line-height: 1.5;">
                Manage multiple LUDO tournament seasons in one place. Create new seasons, track points, and crown champions across different tournaments!
            </p>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-info-circle"></i> How to Use</h3>
                <ol style="margin: 12px 0; padding-left: 20px; line-height: 1.6; font-size: 0.95rem;">
                    <li><strong>Select a season</strong> from the dropdown above</li>
                    <li><strong>Create a new season</strong> for each new tournament</li>
                    <li>Each season has its own teams, matches, and standings</li>
                    <li>Use the admin panel to manage each season</li>
                </ol>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-trophy"></i> Current Season Leader</h3>
                <div id="currentLeader" style="padding: 10px; text-align: center; color: var(--gray);">
                    Select a season to see leader...
                </div>
            </div>
        </div>

        <!-- Seasons Overview Tab -->
        <div id="seasons" class="tab-content">
            <h2>üìÖ All Seasons</h2>
            
            <div class="action-buttons">
                <button class="btn" onclick="openSeasonModal()">
                    <i class="fas fa-plus"></i> Create New Season
                </button>
                <button class="btn btn-info" onclick="exportAllSeasons()">
                    <i class="fas fa-download"></i> Export All Seasons
                </button>
            </div>
            
            <div id="seasonsContainer" class="season-grid">
                <!-- Seasons will be loaded here -->
            </div>
        </div>

        <!-- Points Table Tab -->
        <div id="points" class="tab-content active">
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <h2>üìä Points Table</h2>
                <div id="currentSeasonBadge" class="season-badge">
                    <i class="fas fa-calendar"></i> Season: <span id="currentSeasonName">None Selected</span>
                </div>
            </div>

            <div id="points-empty" class="empty-state">
                <i class="fas fa-users"></i>
                <h3>No Season Selected</h3>
                <p>Select a season from the dropdown to view points table</p>
            </div>

            <div class="points-table-container" style="display: none;">
                <table class="points-table" id="points-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>Players</th>
                            <th>Matches</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="points-table-body">
                        <!-- Points table will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="action-buttons admin-only" style="display: none;">
                <button class="btn btn-success" onclick="downloadPointsTable()">
                    <i class="fas fa-download"></i> Download Excel
                </button>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <h2>üìÖ Tournament Matches</h2>
                <div id="scheduleSeasonBadge" class="season-badge">
                    <i class="fas fa-calendar"></i> Season: <span id="scheduleSeasonName">None Selected</span>
                </div>
            </div>

            <div id="matches-empty" class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>No Season Selected</h3>
                <p>Select a season from the dropdown to view matches</p>
            </div>

            <div class="admin-controls admin-only" style="display: none;">
                <h3><i class="fas fa-plus-circle"></i> Add New Match</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Team 1</label>
                        <select id="newTeam1" class="form-control">
                            <option value="">Select Team 1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Team 2</label>
                        <select id="newTeam2" class="form-control">
                            <option value="">Select Team 2</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="addNewMatch()">
                    <i class="fas fa-plus"></i> Add Match
                </button>
            </div>

            <div id="matches-container">
                <!-- Matches will be populated by JavaScript -->
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin" class="tab-content">
            <h2>‚öôÔ∏è Admin Panel - <span id="adminSeasonName">No Season Selected</span></h2>
            
            <div class="season-selector" style="margin-bottom: 20px;">
                <label>Select Season to Manage:</label>
                <select id="adminSeasonSelect" onchange="loadSeasonForAdmin()">
                    <option value="">Select Season</option>
                </select>
            </div>

            <div id="adminControls">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-users"></i> Manage Teams</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newTeamName" class="form-control" placeholder="Enter team name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="player1Name" class="form-control" placeholder="Player 1 name">
                        </div>
                        <div class="form-group">
                            <input type="text" id="player2Name" class="form-control" placeholder="Player 2 name">
                        </div>
                    </div>
                    <button class="btn" onclick="addNewTeam()">
                        <i class="fas fa-plus"></i> Add Team
                    </button>

                    <div id="teams-empty" class="empty-state" style="display: none;">
                        <i class="fas fa-user-plus"></i>
                        <h3>No Teams Added Yet</h3>
                        <p>Start by adding your first team above</p>
                    </div>

                    <div id="teams-list" style="margin-top: 15px;">
                        <!-- Teams list will be populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-key"></i> Password Management</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Admin Password</label>
                            <input type="password" id="adminPassword" class="form-control" placeholder="New admin password">
                        </div>
                        <div class="form-group">
                            <label>Viewer Password</label>
                            <input type="password" id="viewerPassword" class="form-control" placeholder="New viewer password">
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="updatePasswords()">
                        <i class="fas fa-save"></i> Update Passwords
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-database"></i> Season Data Management</h3>
                    <button class="btn" onclick="exportSeasonData()" style="margin-bottom: 8px;">
                        <i class="fas fa-file-export"></i> Export Season Data
                    </button>
                    <button class="btn" onclick="importSeasonData()">
                        <i class="fas fa-file-import"></i> Import Season Data
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-trophy"></i> Season Completion</h3>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="completeCurrentSeason()" id="completeSeasonBtn">
                            <i class="fas fa-flag-checkered"></i> Mark as Complete
                        </button>
                        <button class="btn btn-warning" onclick="reopenSeason()" id="reopenSeasonBtn" style="display: none;">
                            <i class="fas fa-redo"></i> Re-open
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.95rem;">
                        Status: <span id="seasonStatus" style="font-weight: bold;">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyAQDJbWsCDbgKMdmMZ8Rz_QmTo-kW6ZdHM",
      authDomain: "ludo-tournament-d6e32.firebaseapp.com",
      projectId: "ludo-tournament-d6e32",
      storageBucket: "ludo-tournament-d6e32.firebasestorage.app",
      messagingSenderId: "245161933582",
      appId: "1:245161933582:web:9d18c5bfc74a41f705b55f",
      measurementId: "G-3R2EZR2HK9"
    };  

    let db = null;
    let isFirebaseConnected = false;
    let currentUser = null;
    let currentSeasonId = null;
    let allSeasons = [];
    let passwordsLoaded = false;

    // ==================== DATA STRUCTURES ====================
    const defaultSeasonData = {
        id: '',
        name: '',
        number: 1,
        description: '',
        teams: [],
        matches: [],
        playoffMatches: [],
        nextTeamId: 1,
        nextMatchId: 1,
        nextPlayoffMatchId: 1,
        seasonCompleted: false,
        playoffTeamsCount: 0,
        playoffStage: 'not_started',
        created: '',
        updated: '',
        createdBy: ''
    };

    let currentSeasonData = JSON.parse(JSON.stringify(defaultSeasonData));
    let globalPasswords = { admin: "admin123", viewer: "view123" };

    // ==================== FIREBASE INITIALIZATION ====================
    async function initializeFirebase() {
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            isFirebaseConnected = true;
            document.getElementById('connectionStatus').style.display = 'inline-block';
            console.log('‚úÖ Firebase connected');
            return true;
        } catch (e) {
            console.log('‚ùå Firebase init failed:', e);
            isFirebaseConnected = false;
            return false;
        }
    }

    // ==================== AUTHENTICATION ====================
    function checkAuthentication() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            if (passwordsLoaded) {
                showApp();
            } else {
                setTimeout(checkAuthentication, 100);
            }
        }
    }  

    function login() {
        if (!passwordsLoaded) {
            alert('System still loading. Please wait...');
            return;
        }

        const role = document.getElementById('viewerRole').classList.contains('active')
            ? 'viewer' : 'admin';
        const password = document.getElementById('password').value.trim();
        const storedPassword = globalPasswords[role];

        if (!storedPassword) {
            alert('Password not set in database. Please contact administrator.');
            return;
        }

        if (password === storedPassword) {
            currentUser = { role, loginTime: new Date().toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showApp();
        } else {
            alert('Invalid password! Please try again.');
        }
    }  

    function logout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showLogin();
    }

    function showLogin() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('password').value = '';
        selectRole('viewer');
    }  

    function showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('userRoleDisplay').textContent =
            `Logged in as ${currentUser.role}`;

        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
        });
        document.getElementById('adminTab').style.display =
            currentUser.role === 'admin' ? 'flex' : 'none';
        document.getElementById('newSeasonBtn').style.display =
            currentUser.role === 'admin' ? 'inline-flex' : 'none';

        showTab('welcome');
        loadSeasons();
    }

    // ==================== SEASON MANAGEMENT ====================
    async function loadSeasons() {
        console.log('üîç Loading seasons...');
        
        if (!db || !isFirebaseConnected) {
            console.log('üì± Using localStorage (Firebase not connected)');
            loadSeasonsFromLocal();
            return;
        }

        try {
            console.log('üì• Fetching seasons from Firebase...');
            const seasonsSnapshot = await db.collection('tournaments').get(); // CHANGED: tournaments not seasons
            allSeasons = [];
            
            seasonsSnapshot.forEach(doc => {
                const season = doc.data();
                season.id = doc.id;
                allSeasons.push(season);
                console.log(`Found season: ${season.name} (${season.id})`);
            });

            // Sort by season number
            allSeasons.sort((a, b) => b.number - a.number);
            
            updateSeasonSelectors();
            updateSeasonsDisplay();
            
            // Load first season if none selected
            if (allSeasons.length > 0 && !currentSeasonId) {
                currentSeasonId = allSeasons[0].id;
                loadSeasonData();
            }
            
        } catch (error) {
            console.error('‚ùå Error loading seasons:', error);
            console.log('üîÑ Falling back to localStorage...');
            loadSeasonsFromLocal();
        }
    }

    function loadSeasonsFromLocal() {
        const saved = localStorage.getItem('ludoSeasons');
        if (saved) {
            allSeasons = JSON.parse(saved);
            updateSeasonSelectors();
            updateSeasonsDisplay();
            
            if (allSeasons.length > 0 && !currentSeasonId) {
                currentSeasonId = allSeasons[0].id;
                loadSeasonData();
            }
        } else {
            console.log('üì≠ No seasons found in localStorage');
        }
    }

    function openSeasonModal() {
        if (currentUser?.role !== 'admin') {
            alert('Admin access required to create seasons');
            return;
        }
        document.getElementById('seasonModal').style.display = 'flex';
    }

    function closeSeasonModal() {
        document.getElementById('seasonModal').style.display = 'none';
        document.getElementById('newSeasonName').value = '';
        document.getElementById('newSeasonNumber').value = '';
        document.getElementById('newSeasonDescription').value = '';
    }

    async function createNewSeason() {
        const name = document.getElementById('newSeasonName').value.trim();
        const number = parseInt(document.getElementById('newSeasonNumber').value);
        const description = document.getElementById('newSeasonDescription').value.trim();

        if (!name || !number) {
            alert('Please enter season name and number');
            return;
        }

        // Check if season number already exists
        if (allSeasons.some(s => s.number === number)) {
            alert(`Season #${number} already exists!`);
            return;
        }

        const newSeason = {
            id: 'season_' + Date.now(),
            name,
            number,
            description,
            teams: [],
            matches: [],
            playoffMatches: [],
            nextTeamId: 1,
            nextMatchId: 1,
            nextPlayoffMatchId: 1,
            seasonCompleted: false,
            playoffTeamsCount: 0,
            playoffStage: 'not_started',
            created: new Date().toISOString(),
            updated: new Date().toISOString(),
            createdBy: currentUser?.role || 'unknown'
        };

        console.log('‚ûï Creating new season:', newSeason);

        // Save to Firebase - CHANGED: using 'tournaments' collection
        if (db && isFirebaseConnected) {
            try {
                await db.collection('tournaments').doc(newSeason.id).set(newSeason);
                console.log('‚úÖ Season saved to Firebase tournaments collection');
            } catch (error) {
                console.error('‚ùå Error saving season to Firebase:', error);
                alert('Error saving to database: ' + error.message);
            }
        }

        allSeasons.push(newSeason);
        allSeasons.sort((a, b) => b.number - a.number);
        
        // Save to localStorage
        localStorage.setItem('ludoSeasons', JSON.stringify(allSeasons));
        
        // Update UI
        updateSeasonSelectors();
        updateSeasonsDisplay();
        
        // Select the new season
        currentSeasonId = newSeason.id;
        loadSeasonData();
        
        closeSeasonModal();
        showTab('points');
        
        alert(`‚úÖ Season "${name}" created successfully!`);
    }

    function updateSeasonSelectors() {
        const seasonSelect = document.getElementById('seasonSelect');
        const adminSeasonSelect = document.getElementById('adminSeasonSelect');
        
        if (!seasonSelect || !adminSeasonSelect) return;
        
        seasonSelect.innerHTML = '<option value="">Select Season</option>';
        adminSeasonSelect.innerHTML = '<option value="">Select Season</option>';
        
        allSeasons.forEach(season => {
            const option = document.createElement('option');
            option.value = season.id;
            option.textContent = `Season ${season.number}: ${season.name}`;
            
            const adminOption = option.cloneNode(true);
            
            seasonSelect.appendChild(option);
            adminSeasonSelect.appendChild(adminOption);
        });
        
        if (currentSeasonId) {
            seasonSelect.value = currentSeasonId;
            adminSeasonSelect.value = currentSeasonId;
        }
    }

    function updateSeasonsDisplay() {
        const container = document.getElementById('seasonsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (allSeasons.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <i class="fas fa-calendar-plus"></i>
                    <h3>No Seasons Created Yet</h3>
                    <p>Create your first season to get started</p>
                    <button class="btn" onclick="openSeasonModal()" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> Create First Season
                    </button>
                </div>
            `;
            return;
        }
        
        allSeasons.forEach(season => {
            const card = document.createElement('div');
            card.className = 'season-card';
            
            const isActive = season.id === currentSeasonId;
            const isComplete = season.seasonCompleted;
            
            card.innerHTML = `
                <div class="season-card-header">
                    <div class="season-title">${season.name}</div>
                    <div>
                        ${isComplete ? 
                            '<span style="background: #48bb78; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem;">Completed</span>' :
                            '<span style="background: #ed8936; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem;">Active</span>'
                        }
                    </div>
                </div>
                
                <div style="color: var(--gray); margin-bottom: 10px; font-size: 0.9rem;">
                    <i class="fas fa-hashtag"></i> Season ${season.number}
                </div>
                
                ${season.description ? `<p style="margin-bottom: 15px; color: var(--dark); font-size: 0.9rem;">${season.description}</p>` : ''}
                
                <div class="season-stats">
                    <div class="stat-item">
                        <div class="stat-value">${season.teams?.length || 0}</div>
                        <div class="stat-label">Teams</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${season.matches?.length || 0}</div>
                        <div class="stat-label">Matches</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${getSeasonPointsLeader(season)?.points || 0}</div>
                        <div class="stat-label">Top Points</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-sm" onclick="selectSeason('${season.id}')" 
                            style="flex: 1; ${isActive ? 'background: var(--success);' : ''}">
                        ${isActive ? '<i class="fas fa-check"></i> Selected' : '<i class="fas fa-eye"></i> View'}
                    </button>
                    ${currentUser?.role === 'admin' ? `
                        <button class="btn btn-sm btn-warning" onclick="deleteSeason('${season.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    function getSeasonPointsLeader(season) {
        if (!season.teams || season.teams.length === 0) return null;
        return [...season.teams].sort((a, b) => b.points - a.points)[0];
    }

    function selectSeason(seasonId) {
        currentSeasonId = seasonId;
        loadSeasonData();
        showTab('points');
    }

    // ==================== SEASON DATA LOADING ====================
    async function loadSeasonData() {
        if (!currentSeasonId) return;
        
        const season = allSeasons.find(s => s.id === currentSeasonId);
        if (!season) {
            console.log('‚ùå Season not found:', currentSeasonId);
            return;
        }
        
        console.log('üìÇ Loading season data:', season.name);
        currentSeasonData = JSON.parse(JSON.stringify(season));
        
        // Update UI
        document.getElementById('currentSeasonName').textContent = `${season.number}: ${season.name}`;
        document.getElementById('scheduleSeasonName').textContent = `${season.number}: ${season.name}`;
        document.getElementById('adminSeasonName').textContent = `${season.number}: ${season.name}`;
        
        // Update selectors
        document.getElementById('seasonSelect').value = currentSeasonId;
        document.getElementById('adminSeasonSelect').value = currentSeasonId;
        
        // Update displays
        updateAllSeasonDisplays();
        
        // Show/hide admin controls
        const isAdmin = currentUser?.role === 'admin';
        const hasData = currentSeasonData.teams && currentSeasonData.teams.length > 0;
        
        // Points tab admin controls
        const pointsAdminControls = document.querySelector('#points .admin-only');
        if (pointsAdminControls) {
            pointsAdminControls.style.display = isAdmin ? 'flex' : 'none';
        }
        
        // Schedule tab admin controls
        const scheduleAdminControls = document.querySelector('#schedule .admin-controls');
        if (scheduleAdminControls) {
            scheduleAdminControls.style.display = isAdmin && hasData ? 'block' : 'none';
        }
    }

    function loadSeasonForAdmin() {
        const seasonId = document.getElementById('adminSeasonSelect').value;
        if (seasonId) {
            currentSeasonId = seasonId;
            loadSeasonData();
            showTab('admin');
        }
    }

    // ==================== DATA SAVING ====================
    async function saveSeasonData() {
        if (!currentSeasonId) {
            console.log('‚ö†Ô∏è No season selected, cannot save');
            return;
        }
        
        // Update timestamp
        currentSeasonData.updated = new Date().toISOString();
        
        // üõë Block accidental empty saves
        if (
            currentSeasonData.teams.length === 0 &&
            currentSeasonData.matches.length === 0 &&
            !confirm('You are about to save EMPTY season data. Continue?')
        ) {
            console.warn('‚õî Blocked empty save');
            return;
        }
        
        console.log('üíæ Saving season data:', currentSeasonData.name);
        
        // Update in allSeasons array
        const seasonIndex = allSeasons.findIndex(s => s.id === currentSeasonId);
        if (seasonIndex !== -1) {
            allSeasons[seasonIndex] = JSON.parse(JSON.stringify(currentSeasonData));
        }
        
        // Save to Firebase - CHANGED: using 'tournaments' collection
        if (db && isFirebaseConnected) {
            try {
                await db.collection('tournaments').doc(currentSeasonId).set(currentSeasonData, { merge: true });
                console.log('‚úÖ Season data saved to Firebase tournaments collection');
            } catch (error) {
                console.error('‚ùå Firebase error:', error);
                alert('Error saving to database: ' + error.message);
            }
        }
        
        // Save to localStorage
        localStorage.setItem('ludoSeasons', JSON.stringify(allSeasons));
        
        // Update UI
        updateSeasonsDisplay();
        updateAllSeasonDisplays();
    }

    // ==================== TEAM MANAGEMENT ====================
    function addNewTeam() {
        if (!currentSeasonId) {
            alert('Please select a season first');
            return;
        }

        const nameInput = document.getElementById('newTeamName');
        const player1Input = document.getElementById('player1Name');
        const player2Input = document.getElementById('player2Name');

        const name = nameInput.value.trim();
        const player1 = player1Input.value.trim();
        const player2 = player2Input.value.trim();

        if (!name || !player1 || !player2) {
            alert('Please enter team name and both player names');
            return;
        }

        if (currentSeasonData.teams.some(team =>
            team.name.toLowerCase() === name.toLowerCase())) {
            alert('Team name already exists! Please choose a different name.');
            return;
        }

        currentSeasonData.teams.push({
            id: currentSeasonData.nextTeamId++,
            name,
            player1,
            player2,
            matches: 0,
            wins: 0,
            losses: 0,
            points: 0
        });

        nameInput.value = '';
        player1Input.value = '';
        player2Input.value = '';
        
        saveSeasonData();
    }  

    function editTeam(teamId) {
        const team = currentSeasonData.teams.find(t => t.id === teamId);
        if (!team) return;

        const newName = prompt('Enter new team name:', team.name);
        if (newName === null) return;

        const newPlayer1 = prompt('Enter Player 1 name:', team.player1);
        if (newPlayer1 === null) return;

        const newPlayer2 = prompt('Enter Player 2 name:', team.player2);
        if (newPlayer2 === null) return;

        if (currentSeasonData.teams.some(t =>
            t.id !== teamId && t.name.toLowerCase() === newName.toLowerCase())) {
            alert('Team name already exists! Please choose a different name.');
            return;
        }

        team.name = newName.trim();
        team.player1 = newPlayer1.trim();
        team.player2 = newPlayer2.trim();

        saveSeasonData();
    }  

    function deleteTeam(teamId) {
        if (!confirm('Are you sure you want to delete this team? This will also delete all matches involving this team.')) {
            return;
        }

        currentSeasonData.teams = currentSeasonData.teams.filter(team => team.id !== teamId);
        currentSeasonData.matches = currentSeasonData.matches.filter(match =>
            match.team1 !== teamId && match.team2 !== teamId);
        saveSeasonData();
    }  

    // ==================== MATCH MANAGEMENT ====================
    function addNewMatch() {
        if (!currentSeasonId) {
            alert('Please select a season first');
            return;
        }

        const team1Select = document.getElementById('newTeam1');
        const team2Select = document.getElementById('newTeam2');

        if (!team1Select || !team2Select) {
            alert('Please select a season first');
            return;
        }
        
        const team1 = parseInt(team1Select.value);
        const team2 = parseInt(team2Select.value);

        if (!team1 || !team2) {
            alert('Please select both teams');
            return;
        }

        if (team1 === team2) {
            alert('Please select two different teams');
            return;
        }

        currentSeasonData.matches.push({
            id: currentSeasonData.nextMatchId++,
            team1,
            team2,
            winner: null,
            completed: false,
            resultTimestamp: null
        });

        team1Select.value = '';
        team2Select.value = '';
        saveSeasonData();
    }

    function updateMatchResult(matchId) {
        const winnerSelect = document.getElementById(`winner-${matchId}`);
        const winnerId = parseInt(winnerSelect.value);
    
        if (!winnerId) {
            alert('Please select a winner');
            return;
        }
    
        const match = currentSeasonData.matches.find(m => m.id === matchId);
        if (!match) return;
    
        if (match.completed) {
            alert('This match result has already been set and cannot be changed.');
            return;
        }
    
        match.winner = winnerId;
        match.completed = true;
        match.resultTimestamp = new Date().toISOString();
    
        const winner = currentSeasonData.teams.find(t => t.id === winnerId);
        const loser = currentSeasonData.teams.find(t =>
            t.id === (match.team1 === winnerId ? match.team2 : match.team1));
    
        winner.matches += 1;
        winner.wins += 1;
        winner.points += 2;
    
        loser.matches += 1;
        loser.losses += 1;
    
        saveSeasonData();
    }

    function deleteMatch(matchId) {
        if (!confirm('Are you sure you want to delete this match?')) {
            return;
        }

        const match = currentSeasonData.matches.find(m => m.id === matchId);
        if (match && match.completed) {
            const winner = currentSeasonData.teams.find(t => t.id === match.winner);
            const loserId = match.team1 === match.winner ? match.team2 : match.team1;
            const loser = currentSeasonData.teams.find(t => t.id === loserId);

            if (winner && loser) {
                winner.matches -= 1;
                winner.wins -= 1;
                winner.points -= 2;
                loser.matches -= 1;
                loser.losses -= 1;
            }
        }

        currentSeasonData.matches =
            currentSeasonData.matches.filter(match => match.id !== matchId);
        saveSeasonData();
    }  

    // ==================== DISPLAY FUNCTIONS ====================
    function updateAllSeasonDisplays() {
        updatePointsTable();
        updateMatchesDisplay();
        updateTeamsList();
        updateLeaderDisplay();
        updateTeamSelects();
        updateSeasonStatus();
        
        // Update empty states
        const hasData = currentSeasonData.teams && currentSeasonData.teams.length > 0;
        
        // Points table
        const pointsEmpty = document.getElementById('points-empty');
        const pointsContainer = document.querySelector('.points-table-container');
        if (pointsEmpty && pointsContainer) {
            pointsEmpty.style.display = hasData ? 'none' : 'block';
            pointsContainer.style.display = hasData ? 'block' : 'none';
        }
        
        // Matches
        const matchesEmpty = document.getElementById('matches-empty');
        const matchesAdminControls = document.querySelector('#schedule .admin-controls');
        if (matchesEmpty) {
            matchesEmpty.style.display = hasData ? 'none' : 'block';
        }
        if (matchesAdminControls && currentUser?.role === 'admin') {
            matchesAdminControls.style.display = hasData ? 'block' : 'none';
        }
    }

    function updatePointsTable() {
        const tbody = document.getElementById('points-table-body');
        const container = document.querySelector('.points-table-container');

        if (!tbody || !container) return;
        
        tbody.innerHTML = '';

        if (!currentSeasonData.teams || currentSeasonData.teams.length === 0) {
            return;
        }

        const sortedTeams = [...currentSeasonData.teams].sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            return a.matches - b.matches;
        });

        sortedTeams.forEach((team, index) => {
            const row = document.createElement('tr');
            
            let medal = '';
            if (index === 0) medal = ' ü•á';
            else if (index === 1) medal = ' ü•à';
            else if (index === 2) medal = ' ü•â';
            
            let rowClass = '';
            if (index === 0) rowClass = 'position-1';
            else if (index === 1) rowClass = 'position-2';
            else if (index === 2) rowClass = 'position-3';
            
            row.className = rowClass;
            
            row.innerHTML = `
                <td>${index + 1}${medal}</td>
                <td><strong>${team.name}</strong></td>
                <td>${team.player1}, ${team.player2}</td>
                <td>${team.matches}</td>
                <td>${team.wins}</td>
                <td>${team.losses}</td>
                <td class="team-points"><strong>${team.points}</strong></td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function updateMatchesDisplay() {
        const container = document.getElementById('matches-container');
        if (!container) return;
        
        container.innerHTML = '';

        if (!currentSeasonData.matches || currentSeasonData.matches.length === 0) {
            return;
        }

        currentSeasonData.matches.forEach(match => {
            const team1 = currentSeasonData.teams.find(t => t.id === match.team1);
            const team2 = currentSeasonData.teams.find(t => t.id === match.team2);

            const team1Name = team1 ? team1.name : 'Deleted Team';
            const team2Name = team2 ? team2.name : 'Deleted Team';
            const team1Players = team1 ? `${team1.player1}, ${team1.player2}` : 'N/A';
            const team2Players = team2 ? `${team2.player1}, ${team2.player2}` : 'N/A';

            let statusHtml = '<span class="match-status status-pending">‚è≥ Pending</span>';
            if (!team1 || !team2) {
                statusHtml = '<span class="match-status status-abandoned">‚ùå Abandoned</span>';
            } else if (match.completed) {
                statusHtml = '<span class="match-status status-completed">‚úÖ Completed</span>';
            }

            let winnerInfo = '';
            if (match.completed) {
                const winnerTeam = currentSeasonData.teams.find(t => t.id === match.winner);
                if (winnerTeam) {
                    winnerInfo = `<div style="margin-top: 10px; color: var(--success); font-weight: bold;">
                        Winner: ${winnerTeam.name}
                    </div>`;
                }
            }

            const matchCard = document.createElement('div');
            matchCard.className = 'match-card';

            matchCard.innerHTML = `
                <div style="flex: 1;">
                    <div class="match-teams">
                        <span class="team-name">${team1Name}</span>
                        <span class="vs">VS</span>
                        <span class="team-name">${team2Name}</span>
                    </div>
                    <div class="team-players">
                        ${team1Players} vs ${team2Players}
                    </div>
                    ${winnerInfo}
                </div>
                <div class="match-actions">
                    ${statusHtml}
                    ${currentUser?.role === 'admin' && !match.completed && team1 && team2 ? `
                        <select id="winner-${match.id}" class="form-control" style="margin-bottom: 5px;">
                            <option value="">Select Winner</option>
                            <option value="${team1.id}">${team1Name}</option>
                            <option value="${team2.id}">${team2Name}</option>
                        </select>
                        <button class="btn btn-sm" onclick="updateMatchResult(${match.id})">
                            <i class="fas fa-check"></i> Set Result
                        </button>
                    ` : ''}
                    ${currentUser?.role === 'admin' ? `
                        <button class="btn btn-danger btn-sm" onclick="deleteMatch(${match.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    ` : ''}
                </div>
            `;

            container.appendChild(matchCard);
        });
    }

    function updateTeamsList() {
        const container = document.getElementById('teams-list');
        const emptyState = document.getElementById('teams-empty');

        if (!container) return;
        
        container.innerHTML = '';

        if (!currentSeasonData.teams || currentSeasonData.teams.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';

        currentSeasonData.teams.forEach(team => {
            const teamEl = document.createElement('div');
            teamEl.className = 'team-card';
            teamEl.innerHTML = `
                <div>
                    <div style="font-weight: bold;">${team.name}</div>
                    <div class="team-players">${team.player1}, ${team.player2}</div>
                    <div style="margin-top: 5px; font-size: 0.9rem;">
                        <span style="margin-right: 10px;">Matches: ${team.matches}</span>
                        <span style="margin-right: 10px;">Wins: ${team.wins}</span>
                        <span>Points: ${team.points}</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-warning btn-sm" onclick="editTeam(${team.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTeam(${team.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;
            container.appendChild(teamEl);
        });
    }  

    function updateLeaderDisplay() {
        const leaderDiv = document.getElementById('currentLeader');
        if (!leaderDiv) return;
        
        if (!currentSeasonData.teams || currentSeasonData.teams.length === 0) {
            leaderDiv.innerHTML = 'No teams in this season. Add teams to start the tournament!';
            return;
        }
        
        const sortedTeams = [...currentSeasonData.teams].sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            return a.matches - b.matches;
        });
        
        const leader = sortedTeams[0];
        
        leaderDiv.innerHTML = `
            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeb99 100%); border-radius: 10px; margin-bottom: 15px;">
                <span style="font-size: 2rem;">ü•á</span>
                <h3 style="margin: 10px 0; color: #856404;">CURRENT LEADER</h3>
                <strong style="font-size: 1.5rem; color: #856404;">${leader.name}</strong>
                <div style="margin-top: 10px;">
                    <span style="background: #856404; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                        ${leader.points} POINTS
                    </span>
                </div>
                <div style="margin-top: 10px; color: #856404;">
                    ${leader.matches} matches ‚Ä¢ ${leader.wins} wins ‚Ä¢ ${leader.losses} losses
                </div>
            </div>
        `;
    }

    function updateTeamSelects() {
        const selects = ['newTeam1', 'newTeam2'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Select Team</option>';
            if (currentSeasonData.teams) {
                currentSeasonData.teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    select.appendChild(option);
                });
            }
        });
    }

    function updateSeasonStatus() {
        const statusSpan = document.getElementById('seasonStatus');
        const completeBtn = document.getElementById('completeSeasonBtn');
        const reopenBtn = document.getElementById('reopenSeasonBtn');
        
        if (!statusSpan || !completeBtn || !reopenBtn) return;
        
        if (currentSeasonData.seasonCompleted) {
            statusSpan.innerHTML = 'Completed ‚úÖ';
            statusSpan.style.color = 'var(--success)';
            completeBtn.style.display = 'none';
            reopenBtn.style.display = 'inline-flex';
        } else {
            statusSpan.innerHTML = 'Active ‚è≥';
            statusSpan.style.color = 'var(--warning)';
            completeBtn.style.display = 'inline-flex';
            reopenBtn.style.display = 'none';
        }
    }

    // ==================== SEASON OPERATIONS ====================
    function completeCurrentSeason() {
        if (!confirm('Mark this season as complete? This will prevent further modifications.')) return;
        
        currentSeasonData.seasonCompleted = true;
        currentSeasonData.completedDate = new Date().toISOString();
        saveSeasonData();
        alert('‚úÖ Season marked as complete!');
    }

    function reopenSeason() {
        if (!confirm('Re-open this season for modifications?')) return;
        
        currentSeasonData.seasonCompleted = false;
        delete currentSeasonData.completedDate;
        saveSeasonData();
        alert('‚úÖ Season re-opened for modifications!');
    }

    async function deleteSeason(seasonId) {
        if (!confirm('Are you sure you want to delete this season? This cannot be undone.')) return;
        
        if (seasonId === currentSeasonId) {
            currentSeasonId = null;
            currentSeasonData = JSON.parse(JSON.stringify(defaultSeasonData));
        }
        
        // Remove from array
        allSeasons = allSeasons.filter(s => s.id !== seasonId);
        
        // Delete from Firebase - CHANGED: using 'tournaments' collection
        if (db && isFirebaseConnected) {
            try {
                await db.collection('tournaments').doc(seasonId).delete();
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
            }
        }
        
        // Update localStorage
        localStorage.setItem('ludoSeasons', JSON.stringify(allSeasons));
        
        // Update UI
        updateSeasonSelectors();
        updateSeasonsDisplay();
        updateAllSeasonDisplays();
        
        alert('‚úÖ Season deleted successfully!');
    }

    // ==================== EXPORT/IMPORT ====================
    function downloadPointsTable() {
        if (!currentSeasonData.teams || currentSeasonData.teams.length === 0) {
            alert('No teams to download');
            return;
        }

        const sortedTeams = [...currentSeasonData.teams].sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            return a.matches - b.matches;
        });

        const data = sortedTeams.map((team, index) => ({
            Position: index + 1,
            Team: team.name,
            'Player 1': team.player1,
            'Player 2': team.player2,
            Matches: team.matches,
            Wins: team.wins,
            Losses: team.losses,
            Points: team.points
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `Season ${currentSeasonData.number} - Points`);
        XLSX.writeFile(wb, `ludo_season_${currentSeasonData.number}_points.xlsx`);
    }  

    function exportSeasonData() {
        if (!currentSeasonId) {
            alert('Please select a season first');
            return;
        }
        
        const data = {
            season: currentSeasonData,
            exportDate: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ludo_season_${currentSeasonData.number}_${currentSeasonData.name.replace(/\s+/g, '_')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }  

    function importSeasonData() {
        document.getElementById('importFile').click();
    }

    document.getElementById('importFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (!imported.season) {
                        alert('Invalid season data file');
                        return;
                    }
                    
                    if (confirm(`Import season "${imported.season.name}"? This will overwrite current season data.`)) {
                        currentSeasonData = imported.season;
                        saveSeasonData();
                        alert('‚úÖ Season data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
    });

    function exportAllSeasons() {
        const data = {
            seasons: allSeasons,
            exportDate: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ludo_all_seasons_backup.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // ==================== PASSWORD MANAGEMENT ====================
    async function updatePasswords() {
        const adminPass = document.getElementById('adminPassword').value.trim();
        const viewerPass = document.getElementById('viewerPassword').value.trim();

        if (!adminPass && !viewerPass) {
            alert('Please enter at least one new password');
            return;
        }

        if (adminPass && adminPass.length < 4) {
            alert('Admin password must be at least 4 characters long');
            return;
        }
        if (viewerPass && viewerPass.length < 4) {
            alert('Viewer password must be at least 4 characters long');
            return;
        }

        if (adminPass) globalPasswords.admin = adminPass;
        if (viewerPass) globalPasswords.viewer = viewerPass;

        document.getElementById('adminPassword').value = '';
        document.getElementById('viewerPassword').value = '';

        // Save passwords to Firebase - CHANGED: using 'tournaments' collection
        if (db && isFirebaseConnected) {
            try {
                await db.collection('app_config').doc('passwords').set(globalPasswords);
                console.log('‚úÖ Passwords saved to Firebase');
            } catch (error) {
                console.error('Error saving passwords:', error);
            }
        }

        // Save to localStorage
        localStorage.setItem('ludoPasswords', JSON.stringify(globalPasswords));
        
        passwordsLoaded = true;
        alert('‚úÖ Passwords updated successfully!');
    }

    // ==================== INITIALIZATION ====================
    async function loadData() {
        console.log('üöÄ Initializing application...');
        
        // Initialize Firebase
        const firebaseConnected = await initializeFirebase();
        
        // Load passwords
        if (firebaseConnected && db) {
            try {
                const passDoc = await db.collection('app_config').doc('passwords').get();
                if (passDoc.exists) {
                    globalPasswords = passDoc.data();
                    console.log('‚úÖ Passwords loaded from Firebase');
                } else {
                    console.log('‚ö†Ô∏è No passwords in Firebase, using defaults');
                }
            } catch (error) {
                console.error('Error loading passwords:', error);
            }
        }
        
        // Check localStorage for passwords
        const localPass = localStorage.getItem('ludoPasswords');
        if (localPass) {
            globalPasswords = JSON.parse(localPass);
            console.log('‚úÖ Passwords loaded from localStorage');
        }
        
        passwordsLoaded = true;
        console.log('üîë Passwords ready:', globalPasswords);
        
        // Load seasons
        loadSeasons();
    }

    // ==================== TABS & UI ====================
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
    
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    
        const tabContent = document.getElementById(tabName);
        if (tabContent) {
            tabContent.classList.add('active');
        }
    
        const tabButton = document.getElementById(tabName + 'Tab');
        if (tabButton) {
            tabButton.classList.add('active');
        }
    }

    function setupEventListeners() {
        document.getElementById('viewerRole').addEventListener('click', () => selectRole('viewer'));
        document.getElementById('adminRole').addEventListener('click', () => selectRole('admin'));
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        document.getElementById('logoutBtn').addEventListener('click', logout);
    }  

    function selectRole(role) {
        document.getElementById('viewerRole').classList.toggle('active', role === 'viewer');
        document.getElementById('adminRole').classList.toggle('active', role === 'admin');
    }  

    // ==================== STARTUP ====================
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        loadData();
        checkAuthentication();
    });  
    </script>
</body>
</html>
